# Server Helper Configuration Example
# ====================================
# Copy this file to all.yml and customize for your environment.
# The setup.sh script will generate this file automatically.
#
# Variables are organized with prefixes:
#   - target_*:  Services deployed on managed servers
#   - control_*: Centralized services on the control node
#
# Usage: cp group_vars/all.example.yml group_vars/all.yml

---
# =============================================================================
# TARGET NODE CONFIGURATION
# =============================================================================
# These settings are applied to all managed target servers.

# Target: System Settings
target_hostname: "server"
target_timezone: "America/Vancouver"
target_locale: "en_US.UTF-8"

# Target: Base Directories (Dockge-compatible structure)
target_base_dir: "/opt/server-helper"
target_dockge_base_dir: "/opt/stacks"
target_dockge_stacks_dir: "{{ target_dockge_base_dir }}"
target_dockge_data_dir: "{{ target_dockge_base_dir }}/dockge/data"

# Target: NAS Mounts
target_nas_mounts:
  enabled: false
  shares:
    - name: "backup"
      ip: "192.168.1.100"
      share_name: "backup"
      mount_point: "/mnt/nas/backup"
      username: "{{ vault_nas_credentials[0].username }}"
      password: "{{ vault_nas_credentials[0].password }}"
      smb_version: "3.0"
      options: "_netdev,nofail"

# Target: LVM Configuration
target_lvm_config:
  enabled: true
  auto_extend_ubuntu: true
  custom_lvs: []
  create_lvs: []

# Target: System Users
target_system_users:
  create_admin_user: false
  admin_user: "admin"
  admin_password: "{{ vault_system_users.admin_password }}"
  admin_groups:
    - sudo
    - docker
  admin_passwordless_sudo: true
  admin_ssh_key: "{{ vault_system_users.admin_ssh_key }}"
  disable_root_password: true
  additional_users: []

# Target: Dockge (Container Management UI)
target_dockge:
  enabled: true
  port: 5001
  version: "1"

# Target: Netdata (System Monitoring)
target_netdata:
  enabled: true
  port: 19999
  version: "latest"
  mode: "child"  # Streams to control node parent
  claim_token: ""
  claim_rooms: ""
  alarms:
    enabled: true
    cpu_warning: 80
    cpu_critical: 95
    ram_warning: 80
    ram_critical: 95
    disk_warning: 80
    disk_critical: 90
    check_interval_minutes: 5
  uptime_kuma_push_urls:
    cpu: ""
    ram: ""
    disk: ""
    system: ""

# Target: Restic (Encrypted Backups)
target_restic:
  enabled: true
  schedule: "0 2 * * *"
  retention:
    keep_daily: 7
    keep_weekly: 4
    keep_monthly: 6
    keep_yearly: 2
  destinations:
    nas:
      enabled: false
      path: "/mnt/nas/backup/restic"
    local:
      enabled: true
      path: "/opt/backups/restic"
    s3:
      enabled: false
      bucket: ""
      endpoint: "s3.amazonaws.com"
      region: "us-east-1"
    b2:
      enabled: false
      bucket: ""
  include_paths:
    - "{{ target_dockge_stacks_dir }}"
    - "/etc"
    - "/root"
    - "/home"
  exclude_patterns:
    - "*.tmp"
    - "*.log"
    - "cache"
    - "*.cache"

# Target: Security
target_security:
  basic_hardening: true
  lynis:
    enabled: true
    schedule: "0 3 * * 0"
  fail2ban:
    enabled: true
    sshd_maxretry: 3
    sshd_bantime: 86400
  ufw:
    enabled: true
    default_incoming: deny
    default_outgoing: allow
  ssh_hardening:
    enabled: true
    permit_root_login: false
    password_authentication: false
    pubkey_authentication: true
    max_auth_tries: 3

# Target: Logging (Promtail - streams to Loki)
target_logging:
  promtail:
    enabled: true
    additional_jobs: []

# Target: Watchtower (Container Auto-Updates)
target_watchtower:
  enabled: true
  schedule: "0 4 * * *"
  cleanup: true

# Target: Docker Configuration
target_docker:
  version: "latest"
  compose_version: "v2"
  storage_driver: "overlay2"
  log_driver: "json-file"
  log_max_size: "10m"
  log_max_file: "3"

# Target: System Maintenance
target_maintenance:
  auto_cleanup:
    enabled: true
    disk_threshold: 80
    schedule: "0 5 * * 0"
  auto_updates:
    enabled: false
    schedule: "0 6 * * 0"
    auto_reboot: false
    reboot_time: "03:00"

# Target: Virtualization
target_virtualization:
  qemu_guest_agent: true

# =============================================================================
# CONTROL NODE CONFIGURATION
# =============================================================================
# These settings configure centralized services on the control node.

control_node_ip: "192.168.1.10"
control_node_install_dir: "/opt/stacks"

# Control: Authentik (SSO/Identity Provider)
control_authentik:
  enabled: true
  port: 9000
  version: "latest"

# Control: Traefik (Reverse Proxy)
control_traefik:
  enabled: true
  http_port: 80
  https_port: 443
  dashboard_port: 8080
  version: "v3.0"

# Control: Step-CA (Internal Certificate Authority)
control_step_ca:
  enabled: true
  port: 9443
  ca_name: "Server-Helper CA"

# Control: Pi-hole + Unbound (DNS)
control_dns:
  enabled: true
  pihole_port: 8053
  dns_port: 53

# Control: Uptime Kuma (Availability Monitoring)
control_uptime_kuma:
  enabled: true
  port: 3001
  version: "1"

# Control: Grafana (Centralized Dashboards)
control_grafana:
  enabled: true
  port: 3000
  version: "latest"
  admin_user: "admin"
  oidc_enabled: true  # Use Authentik for SSO

# Control: Loki (Centralized Log Aggregation)
control_loki:
  enabled: true
  port: 3100
  version: "latest"
  retention_period: "744h"

# Control: Netdata Parent (Centralized Metrics)
control_netdata:
  enabled: true
  port: 19999
  version: "latest"
  mode: "parent"
  stream_api_key: "{{ vault_netdata_stream_api_key }}"

# Control: Scanopy/Trivy (Container Security)
control_scanopy:
  enabled: true
  port: 8080
  trivy_version: "latest"

# Control: PruneMate (Docker Cleanup)
control_prunemate:
  enabled: true
  schedule: "0 3 * * 0"

# =============================================================================
# SERVICE DISCOVERY & AUTO-REGISTRATION
# =============================================================================
# Target nodes use these settings to connect to control node services.

service_discovery:
  enabled: true
  control_node_ip: "{{ control_node_ip }}"
  netdata_streaming:
    enabled: true
    parent_host: "{{ control_node_ip }}"
    parent_port: 19999
    api_key: "{{ vault_netdata_stream_api_key }}"
  log_aggregation:
    enabled: true
    loki_url: "http://{{ control_node_ip }}:3100/loki/api/v1/push"
  uptime_monitoring:
    enabled: true
    monitored_services:
      - name: "Dockge"
        type: "http"
        port: "{{ target_dockge.port }}"
      - name: "Netdata"
        type: "http"
        port: "{{ target_netdata.port }}"
      - name: "SSH"
        type: "port"
        port: 22
  dns_registration:
    enabled: false
    domain: "local"

# =============================================================================
# DEBUG & FEATURE FLAGS
# =============================================================================
debug_mode: false
