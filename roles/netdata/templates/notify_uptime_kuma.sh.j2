#!/bin/bash
# Netdata to Uptime Kuma Push Monitor Integration
# Generated by Ansible - Server Helper v1.0.0

# Uptime Kuma Push URLs
{% if netdata.alarms.uptime_kuma_urls.cpu | default('') | length > 0 %}
UPTIME_KUMA_CPU_URL="{{ netdata.alarms.uptime_kuma_urls.cpu }}"
{% else %}
UPTIME_KUMA_CPU_URL=""
{% endif %}

{% if netdata.alarms.uptime_kuma_urls.ram | default('') | length > 0 %}
UPTIME_KUMA_RAM_URL="{{ netdata.alarms.uptime_kuma_urls.ram }}"
{% else %}
UPTIME_KUMA_RAM_URL=""
{% endif %}

{% if netdata.alarms.uptime_kuma_urls.disk | default('') | length > 0 %}
UPTIME_KUMA_DISK_URL="{{ netdata.alarms.uptime_kuma_urls.disk }}"
{% else %}
UPTIME_KUMA_DISK_URL=""
{% endif %}

{% if netdata.alarms.uptime_kuma_urls.docker | default('') | length > 0 %}
UPTIME_KUMA_DOCKER_URL="{{ netdata.alarms.uptime_kuma_urls.docker }}"
{% else %}
UPTIME_KUMA_DOCKER_URL=""
{% endif %}

# Function to send alert to Uptime Kuma
send_alert() {
    local url="$1"
    local status="$2"
    local message="$3"
    
    if [ -z "$url" ]; then
        return 0
    fi
    
    # URL encode the message
    local encoded_msg=$(echo -n "$message" | jq -sRr @uri)
    
    # Send alert
    curl -fsS -m 10 "${url}?status=${status}&msg=${encoded_msg}" >/dev/null 2>&1
    
    return $?
}

# Determine which alarm triggered based on alarm name
case "${NETDATA_ALARM_NAME}" in
    cpu_usage_*|cpu_iowait_*)
        URL="$UPTIME_KUMA_CPU_URL"
        TYPE="CPU"
        ;;
    ram_*|swap_*|oom_*)
        URL="$UPTIME_KUMA_RAM_URL"
        TYPE="RAM"
        ;;
    disk_*)
        URL="$UPTIME_KUMA_DISK_URL"
        TYPE="Disk"
        ;;
    docker_*|dockerd_*)
        URL="$UPTIME_KUMA_DOCKER_URL"
        TYPE="Docker"
        ;;
    *)
        # Unknown alarm type
        exit 0
        ;;
esac

# Determine status
case "${NETDATA_ALARM_STATUS}" in
    CRITICAL)
        STATUS="down"
        ;;
    WARNING)
        STATUS="down"
        ;;
    CLEAR)
        STATUS="up"
        ;;
    *)
        STATUS="up"
        ;;
esac

# Build message
MESSAGE="${TYPE} Alert: ${NETDATA_ALARM_NAME} - ${NETDATA_ALARM_STATUS}"
if [ -n "${NETDATA_ALARM_INFO}" ]; then
    MESSAGE="${MESSAGE} - ${NETDATA_ALARM_INFO}"
fi
if [ -n "${NETDATA_ALARM_VALUE}" ]; then
    MESSAGE="${MESSAGE} (Current: ${NETDATA_ALARM_VALUE}${NETDATA_ALARM_UNITS})"
fi

# Send alert
send_alert "$URL" "$STATUS" "$MESSAGE"

exit 0
