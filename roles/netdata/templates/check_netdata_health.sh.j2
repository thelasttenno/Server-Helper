#!/bin/bash
# Netdata Health Check Script
# Generated by Ansible - Server Helper v1.0.0
# Checks Netdata API and sends status to Uptime Kuma

NETDATA_URL="http://localhost:{{ target_netdata.port }}"
{% if vault_uptime_kuma_push_urls.system | default('') | length > 0 %}
UPTIME_KUMA_URL="{{ vault_uptime_kuma_push_urls.system }}"
{% else %}
UPTIME_KUMA_URL=""
{% endif %}

# Check Netdata health
check_netdata() {
    local response
    response=$(curl -fsS -m 10 "${NETDATA_URL}/api/v1/info" 2>&1)
    local exit_code=$?
    
    if [ $exit_code -eq 0 ]; then
        return 0
    else
        return 1
    fi
}

# Send status to Uptime Kuma
send_status() {
    local status="$1"
    local message="$2"
    
    if [ -z "$UPTIME_KUMA_URL" ]; then
        return 0
    fi
    
    local encoded_msg=$(echo -n "$message" | jq -sRr @uri 2>/dev/null || echo "$message")
    curl -fsS -m 10 "${UPTIME_KUMA_URL}?status=${status}&msg=${encoded_msg}" >/dev/null 2>&1
    
    return $?
}

# Main health check
if check_netdata; then
    send_status "up" "Netdata is healthy"
    exit 0
else
    send_status "down" "Netdata is not responding"

    # Trigger auto-remediation if enabled
    {% if (target_netdata.auto_remediation | default({})).enabled | default(false) %}
    echo "[$(date)] Netdata health check failed - triggering auto-restart" >> /var/log/auto-remediation.log
    /usr/local/bin/trigger-service-restart.sh "netdata" "critical" &
    {% endif %}

    exit 1
fi
