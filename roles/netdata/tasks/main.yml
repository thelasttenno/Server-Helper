---
# Netdata Role - Configure alarms and notifications
# This role configures Netdata health alarms and Uptime Kuma integration

- name: Wait for Netdata container to be healthy
  uri:
    url: "http://localhost:{{ netdata.port }}/api/v1/info"
    status_code: 200
  register: netdata_health
  until: netdata_health.status == 200
  retries: 30
  delay: 5
  when: netdata.enabled | default(true)

- name: Create Netdata config directories
  file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - "{{ dockge.data_dir }}/stacks/netdata/config"
    - "{{ dockge.data_dir }}/stacks/netdata/config/health.d"
    - "{{ dockge.data_dir }}/stacks/netdata/config/health_alarm_notify.conf.d"
  when: netdata.enabled | default(true)

- name: Configure CPU alarm
  template:
    src: health.d/cpu.conf.j2
    dest: "{{ dockge.data_dir }}/stacks/netdata/config/health.d/cpu.conf"
    mode: '0644'
  when: 
    - netdata.enabled | default(true)
    - netdata.alarms.enabled | default(true)
  notify: restart netdata

- name: Configure RAM alarm
  template:
    src: health.d/ram.conf.j2
    dest: "{{ dockge.data_dir }}/stacks/netdata/config/health.d/ram.conf"
    mode: '0644'
  when: 
    - netdata.enabled | default(true)
    - netdata.alarms.enabled | default(true)
  notify: restart netdata

- name: Configure disk alarm
  template:
    src: health.d/disk.conf.j2
    dest: "{{ dockge.data_dir }}/stacks/netdata/config/health.d/disk.conf"
    mode: '0644'
  when: 
    - netdata.enabled | default(true)
    - netdata.alarms.enabled | default(true)
  notify: restart netdata

- name: Configure Docker container monitoring
  template:
    src: health.d/docker.conf.j2
    dest: "{{ dockge.data_dir }}/stacks/netdata/config/health.d/docker.conf"
    mode: '0644'
  when: 
    - netdata.enabled | default(true)
    - netdata.alarms.enabled | default(true)
  notify: restart netdata

- name: Create Uptime Kuma notification script
  template:
    src: notify_uptime_kuma.sh.j2
    dest: /usr/local/bin/netdata_notify_uptime_kuma.sh
    mode: '0755'
  when:
    - netdata.enabled | default(true)
    - netdata.alarms.enabled | default(true)
    - netdata.alarms.uptime_kuma_urls.cpu | default('') | length > 0

- name: Configure Netdata alarm notifications
  template:
    src: health_alarm_notify.conf.j2
    dest: "{{ dockge.data_dir }}/stacks/netdata/config/health_alarm_notify.conf.d/uptime_kuma.conf"
    mode: '0644'
  when:
    - netdata.enabled | default(true)
    - netdata.alarms.enabled | default(true)
  notify: restart netdata

- name: Create Netdata API health check script
  template:
    src: check_netdata_health.sh.j2
    dest: /usr/local/bin/check_netdata_health.sh
    mode: '0755'
  when: netdata.enabled | default(true)

- name: Create systemd timer for Netdata health checks
  template:
    src: netdata-health-check.timer.j2
    dest: /etc/systemd/system/netdata-health-check.timer
    mode: '0644'
  when:
    - netdata.enabled | default(true)
    - netdata.alarms.enabled | default(true)
  notify:
    - reload systemd
    - enable netdata health check timer

- name: Create systemd service for Netdata health checks
  template:
    src: netdata-health-check.service.j2
    dest: /etc/systemd/system/netdata-health-check.service
    mode: '0644'
  when:
    - netdata.enabled | default(true)
    - netdata.alarms.enabled | default(true)
  notify:
    - reload systemd
    - enable netdata health check timer

- name: Display Netdata information
  debug:
    msg:
      - "Netdata is configured!"
      - "Access at: http://{{ ansible_host }}:{{ netdata.port }}"
      - "Alarms configured for:"
      - "  - CPU usage (warning: {{ netdata.alarms.cpu_warning }}%, critical: {{ netdata.alarms.cpu_critical }}%)"
      - "  - RAM usage (warning: {{ netdata.alarms.ram_warning }}%, critical: {{ netdata.alarms.ram_critical }}%)"
      - "  - Disk usage (warning: {{ netdata.alarms.disk_warning }}%, critical: {{ netdata.alarms.disk_critical }}%)"
      - "  - Docker containers (tracks all running containers)"
      - "Health checks run every {{ netdata.alarms.check_interval_minutes | default(5) }} minutes"
  when: netdata.enabled | default(true)
