---
# Role: netdata â€” Deploy Netdata as Docker container (child or parent mode)

- name: Set Netdata stack directory
  ansible.builtin.set_fact:
    netdata_stack_dir: "{{ docker_stack_path }}/netdata"

- name: Create Netdata stack directory
  ansible.builtin.file:
    path: "{{ netdata_stack_dir }}"
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Create Netdata config directories
  ansible.builtin.file:
    path: "{{ netdata_stack_dir }}/{{ item }}"
    state: directory
    owner: root
    group: root
    mode: "0755"
  loop:
    - config
    - config/health.d

- name: Deploy Netdata Docker Compose
  ansible.builtin.template:
    src: docker-compose.yml.j2
    dest: "{{ netdata_stack_dir }}/docker-compose.yml"
    owner: root
    group: root
    mode: "0644"

- name: Deploy Netdata environment file
  ansible.builtin.template:
    src: netdata.env.j2
    dest: "{{ netdata_stack_dir }}/.env"
    owner: root
    group: root
    mode: "0600"
  no_log: true

- name: Deploy Netdata configuration
  ansible.builtin.template:
    src: netdata.conf.j2
    dest: "{{ netdata_stack_dir }}/config/netdata.conf"
    owner: root
    group: root
    mode: "0644"
  notify: Restart Netdata

- name: Deploy Netdata streaming configuration
  ansible.builtin.template:
    src: stream.conf.j2
    dest: "{{ netdata_stack_dir }}/config/stream.conf"
    owner: root
    group: root
    mode: "0600"
  no_log: true
  notify: Restart Netdata

- name: Deploy CPU alarm configuration
  ansible.builtin.template:
    src: health.d/cpu.conf.j2
    dest: "{{ netdata_stack_dir }}/config/health.d/cpu.conf"
    owner: root
    group: root
    mode: "0644"
  notify: Restart Netdata

- name: Deploy RAM alarm configuration
  ansible.builtin.template:
    src: health.d/ram.conf.j2
    dest: "{{ netdata_stack_dir }}/config/health.d/ram.conf"
    owner: root
    group: root
    mode: "0644"
  notify: Restart Netdata

- name: Deploy Disk alarm configuration
  ansible.builtin.template:
    src: health.d/disk.conf.j2
    dest: "{{ netdata_stack_dir }}/config/health.d/disk.conf"
    owner: root
    group: root
    mode: "0644"
  notify: Restart Netdata

- name: Start Netdata
  community.docker.docker_compose_v2:
    project_src: "{{ netdata_stack_dir }}"
    state: present
