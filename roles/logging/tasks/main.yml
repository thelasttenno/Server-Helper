---
# Logging & Visualization Stack Setup
# Installs Loki + Promtail + Grafana for centralized logging
# Supports sending logs to control node's Loki when service_discovery is enabled

- name: Set logging stack directory
  ansible.builtin.set_fact:
    logging_stack_dir: "{{ target_dockge_stacks_dir }}/logging"

- name: Create logging stack directory
  ansible.builtin.file:
    path: "{{ logging_stack_dir }}"
    state: directory
    mode: '0755'
    owner: root
    group: root

- name: Create Grafana provisioning directories
  ansible.builtin.file:
    path: "{{ logging_stack_dir }}/grafana-provisioning/{{ item }}"
    state: directory
    mode: '0755'
    owner: root
    group: root
  loop:
    - datasources
    - dashboards
  when: target_logging.grafana.enabled | default(true)

- name: Deploy Loki configuration
  ansible.builtin.template:
    src: loki-config.yml.j2
    dest: "{{ logging_stack_dir }}/loki-config.yml"
    mode: '0644'
    owner: root
    group: root
  notify: Restart logging stack
  when: target_logging.loki.enabled | default(true)

- name: Deploy Promtail configuration
  ansible.builtin.template:
    src: promtail-config.yml.j2
    dest: "{{ logging_stack_dir }}/promtail-config.yml"
    mode: '0644'
    owner: root
    group: root
  notify: Restart logging stack

- name: Deploy Grafana datasource provisioning
  ansible.builtin.template:
    src: grafana-provisioning/datasources/loki.yml.j2
    dest: "{{ logging_stack_dir }}/grafana-provisioning/datasources/loki.yml"
    mode: '0644'
    owner: root
    group: root
  notify: Restart logging stack
  when: target_logging.grafana.enabled | default(true)

- name: Deploy Grafana dashboard provisioning
  ansible.builtin.template:
    src: grafana-provisioning/dashboards/dashboards.yml.j2
    dest: "{{ logging_stack_dir }}/grafana-provisioning/dashboards/dashboards.yml"
    mode: '0644'
    owner: root
    group: root
  notify: Restart logging stack
  when: target_logging.grafana.enabled | default(true)

- name: Deploy logging docker-compose file
  ansible.builtin.template:
    src: docker-compose.logging.yml.j2
    dest: "{{ logging_stack_dir }}/docker-compose.yml"
    mode: '0644'
    owner: root
    group: root
  notify: Restart logging stack

- name: Ensure monitoring network exists
  community.docker.docker_network:
    name: monitoring
    state: present

- name: Start logging stack
  community.docker.docker_compose:
    project_src: "{{ logging_stack_dir }}"
    state: present
    pull: true
  register: logging_output

- name: Wait for Loki to be ready
  ansible.builtin.uri:
    url: "http://localhost:{{ target_logging.loki.port | default(3100) }}/ready"
    method: GET
    status_code: 200
  retries: 30
  delay: 5
  when:
    - target_logging.loki.enabled | default(true)
    - not (service_discovery.log_aggregation.enabled | default(false) and control_node_ip | default('') | length > 0)

- name: Wait for Grafana to be ready
  ansible.builtin.uri:
    url: "http://localhost:{{ target_logging.grafana.port | default(3000) }}/api/health"
    method: GET
    status_code: 200
  retries: 30
  delay: 5
  when: target_logging.grafana.enabled | default(true)

- name: Display logging stack information (standalone mode)
  ansible.builtin.debug:
    msg:
      - "Logging stack deployed successfully!"
      - "Grafana: http://{{ ansible_default_ipv4.address }}:{{ target_logging.grafana.port | default(3000) }}"
      - "  Username: admin"
      - "  Password: [stored in vault]"
      - "Loki: http://{{ ansible_default_ipv4.address }}:{{ target_logging.loki.port | default(3100) }}"
      - "Promtail: Running on host {{ target_hostname | default(ansible_hostname) }}"
      - ""
      - "Next steps:"
      - "1. Access Grafana and explore pre-configured Loki datasource"
      - "2. Create dashboards or import existing ones"
      - "3. Use Explore feature to query logs"
  when: not (service_discovery.log_aggregation.enabled | default(false) and control_node_ip | default('') | length > 0)

- name: Display logging stack information (centralized mode)
  ansible.builtin.debug:
    msg:
      - "Promtail deployed - sending logs to central Loki!"
      - "Central Loki: http://{{ control_node_ip }}:{{ control_loki.port | default(3100) }}"
      - "Promtail: Running on host {{ target_hostname | default(ansible_hostname) }}"
      - ""
      - "Logs from this host will appear in the control node's Grafana dashboard"
      - "Access central Grafana at: http://{{ control_node_ip }}:{{ control_grafana.port | default(3000) }}"
      - ""
      - "Auto-registration: ENABLED"
  when:
    - service_discovery.enabled | default(false)
    - service_discovery.log_aggregation.enabled | default(false)
    - control_node_ip | default('') | length > 0
