---
- name: Create Grafana stack directory
  ansible.builtin.file:
    path: "{{ docker_stack_path }}/grafana/provisioning/{{ item }}"
    state: directory
    owner: root
    group: root
    mode: "0755"
  loop:
    - datasources
    - dashboards

- name: Deploy Grafana Docker Compose
  ansible.builtin.template:
    src: docker-compose.yml.j2
    dest: "{{ docker_stack_path }}/grafana/docker-compose.yml"
    owner: root
    group: root
    mode: "0644"

- name: Deploy Grafana environment file
  ansible.builtin.template:
    src: grafana.env.j2
    dest: "{{ docker_stack_path }}/grafana/.env"
    owner: root
    group: root
    mode: "0600"
  no_log: true

- name: Deploy Grafana configuration
  ansible.builtin.template:
    src: grafana.ini.j2
    dest: "{{ docker_stack_path }}/grafana/grafana.ini"
    owner: root
    group: root
    mode: "0644"

- name: Deploy Grafana datasources provisioning
  ansible.builtin.template:
    src: datasources.yml.j2
    dest: "{{ docker_stack_path }}/grafana/provisioning/datasources/datasources.yml"
    owner: root
    group: root
    mode: "0644"

- name: Deploy Grafana dashboards provisioning
  ansible.builtin.template:
    src: dashboards.yml.j2
    dest: "{{ docker_stack_path }}/grafana/provisioning/dashboards/dashboards.yml"
    owner: root
    group: root
    mode: "0644"

- name: Create Grafana dashboards directory
  ansible.builtin.file:
    path: "{{ docker_stack_path }}/grafana/dashboards"
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Deploy Grafana dashboard JSON files
  ansible.builtin.copy:
    src: "dashboards/"
    dest: "{{ docker_stack_path }}/grafana/dashboards/"
    owner: root
    group: root
    mode: "0644"

- name: Start Grafana
  community.docker.docker_compose_v2:
    project_src: "{{ docker_stack_path }}/grafana"
    state: present
