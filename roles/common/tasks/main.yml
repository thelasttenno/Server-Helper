---
# Role: common â€” Main tasks
# Installs base packages, chrony, locale, microcode, logrotate, sysctl

- name: Update apt cache
  ansible.builtin.apt:
    update_cache: true
    cache_valid_time: 3600
  when: ansible_os_family == "Debian"

- name: Upgrade all packages
  ansible.builtin.apt:
    upgrade: safe
  when:
    - ansible_os_family == "Debian"
    - common_upgrade_packages | bool

- name: Install base packages
  ansible.builtin.apt:
    name: "{{ common_packages }}"
    state: present
  when: ansible_os_family == "Debian"

- name: Set timezone
  community.general.timezone:
    name: "{{ target_timezone }}"

- name: Install and configure chrony
  ansible.builtin.apt:
    name: chrony
    state: present

- name: Deploy chrony configuration
  ansible.builtin.template:
    src: chrony.conf.j2
    dest: /etc/chrony/chrony.conf
    owner: root
    group: root
    mode: "0644"
  notify: Restart chrony

- name: Ensure chrony is enabled and running
  ansible.builtin.systemd:
    name: chrony
    enabled: true
    state: started

- name: Configure locale
  ansible.builtin.locale_gen:
    name: en_US.UTF-8
    state: present

- name: Install CPU microcode
  ansible.builtin.apt:
    name: "{{ 'intel-microcode' if ansible_processor[1] is search('Intel') else 'amd64-microcode' }}"
    state: present
  when:
    - common_microcode_enabled | bool
    - ansible_virtualization_role != "guest"
  ignore_errors: true

- name: Deploy Docker logrotate configuration
  ansible.builtin.template:
    src: docker-logrotate.j2
    dest: /etc/logrotate.d/docker-containers
    owner: root
    group: root
    mode: "0644"

- name: Apply sysctl tuning
  ansible.posix.sysctl:
    name: "{{ item.key }}"
    value: "{{ item.value }}"
    sysctl_set: true
    state: present
    reload: true
  loop:
    - { key: "vm.swappiness", value: "10" }
    - { key: "net.core.somaxconn", value: "65535" }
    - { key: "net.ipv4.tcp_max_syn_backlog", value: "65535" }
    - { key: "fs.file-max", value: "2097152" }
    - { key: "fs.inotify.max_user_watches", value: "524288" }
    - { key: "net.ipv4.ip_forward", value: "1" }
  when: common_sysctl_tuning | bool
