#!/bin/bash
# {{ ansible_managed }}
# Lynis weekly security scan script

LOG_DIR="/var/log/lynis"
mkdir -p "${LOG_DIR}"

TIMESTAMP=$(date +%Y%m%d_%H%M%S)
LOG_FILE="${LOG_DIR}/lynis-audit-${TIMESTAMP}.log"

echo "Starting Lynis audit at $(date)" | tee "${LOG_FILE}"
lynis audit system --no-colors --quiet >> "${LOG_FILE}" 2>&1

# Keep only last 4 reports
ls -t "${LOG_DIR}"/lynis-audit-*.log 2>/dev/null | tail -n +5 | xargs -r rm

echo "Lynis audit complete at $(date)" | tee -a "${LOG_FILE}"
