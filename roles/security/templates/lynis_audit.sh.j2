#!/bin/bash
# Server Helper - Lynis Security Audit Script

set -euo pipefail

REPORT_DIR="{{ base_install_dir }}/reports"
REPORT_FILE="$REPORT_DIR/lynis-$(date +%Y%m%d-%H%M%S).log"

mkdir -p "$REPORT_DIR"

echo "Running Lynis security audit..."
echo "Report will be saved to: $REPORT_FILE"

# Run Lynis audit
lynis audit system \
    --quick \
    --log-file "$REPORT_FILE" \
    --report-file "$REPORT_FILE"

# Display summary
echo ""
echo "=========================================="
echo "Lynis Audit Complete"
echo "=========================================="
echo "Full report: $REPORT_FILE"
echo ""
grep "Hardening index" "$REPORT_FILE" || true
grep "Lynis security scan details:" -A 10 "$REPORT_FILE" || true

# Clean old reports (keep last 30 days)
find "$REPORT_DIR" -name "lynis-*.log" -mtime +30 -delete

exit 0
