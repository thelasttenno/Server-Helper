groups:
  # Service Health Alerts
  - name: service_health
    interval: 30s
    rules:
      - alert: ServiceDown
        expr: up{job="docker"} == 0
        for: 2m
        labels:
          severity: critical
          category: service
        annotations:
          summary: "Service {{`{{ $labels.instance }}`}} is down"
          description: "{{`{{ $labels.job }}`}} on {{`{{ $labels.instance }}`}} has been down for more than 2 minutes."
          remediation_action: "service_restart"
          remediation_service: "{{`{{ $labels.job }}`}}"

      - alert: ContainerDown
        expr: engine_daemon_container_states_containers{state="running"} == 0
        for: 5m
        labels:
          severity: warning
          category: container
        annotations:
          summary: "No containers running"
          description: "No Docker containers are running on {{`{{ $labels.instance }}`}}"
          remediation_action: "service_restart"
          remediation_service: "docker"

  # Disk Space Alerts
  - name: disk_space
    interval: 60s
    rules:
      - alert: DiskSpaceWarning
        expr: (node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"}) * 100 < 20
        for: 5m
        labels:
          severity: warning
          category: disk
        annotations:
          summary: "Disk space below 20% on {{`{{ $labels.instance }}`}}"
          description: "Available: {{`{{ humanize $value }}`}}%"
          remediation_action: "disk_cleanup"

      - alert: DiskSpaceCritical
        expr: (node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"}) * 100 < 10
        for: 2m
        labels:
          severity: critical
          category: disk
        annotations:
          summary: "CRITICAL: Disk space below 10% on {{`{{ $labels.instance }}`}}"
          description: "Available: {{`{{ humanize $value }}`}}%. Immediate cleanup required!"
          remediation_action: "disk_cleanup"

  # Certificate Expiration Alerts
  - name: certificates
    interval: 3600s
    rules:
      - alert: CertificateExpiringWarning
        expr: (ssl_certificate_expiry_seconds - time()) / 86400 < 30
        for: 1h
        labels:
          severity: warning
          category: certificate
        annotations:
          summary: "Certificate expiring in less than 30 days"
          description: "Certificate {{`{{ $labels.cn }}`}} expires in {{`{{ humanize $value }}`}} days"
          remediation_action: "cert_renewal"

      - alert: CertificateExpiringCritical
        expr: (ssl_certificate_expiry_seconds - time()) / 86400 < 7
        for: 10m
        labels:
          severity: critical
          category: certificate
        annotations:
          summary: "CRITICAL: Certificate expiring in less than 7 days"
          description: "Certificate {{`{{ $labels.cn }}`}} expires in {{`{{ humanize $value }}`}} days"
          remediation_action: "cert_renewal"

  # Resource Utilization Alerts
  - name: resources
    interval: 30s
    rules:
      - alert: HighCPUUsage
        expr: 100 - (avg by (instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 85
        for: 10m
        labels:
          severity: warning
          category: cpu
        annotations:
          summary: "High CPU usage on {{`{{ $labels.instance }}`}}"
          description: "CPU usage is {{`{{ humanize $value }}`}}% for more than 10 minutes"
          remediation_action: "health_check"

      - alert: HighMemoryUsage
        expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 90
        for: 5m
        labels:
          severity: warning
          category: memory
        annotations:
          summary: "High memory usage on {{`{{ $labels.instance }}`}}"
          description: "Memory usage is {{`{{ humanize $value }}`}}%"
          remediation_action: "health_check"

  # Container-specific Alerts
  - name: containers
    interval: 30s
    rules:
      - alert: ContainerHighMemory
        expr: container_memory_usage_bytes / container_spec_memory_limit_bytes * 100 > 90
        for: 5m
        labels:
          severity: warning
          category: container
        annotations:
          summary: "Container {{`{{ $labels.name }}`}} using high memory"
          description: "Container memory usage: {{`{{ humanize $value }}`}}%"
          remediation_action: "service_restart"
          remediation_service: "{{`{{ $labels.name }}`}}"

      - alert: ContainerRestarting
        expr: rate(container_restart_count[15m]) > 0
        for: 5m
        labels:
          severity: warning
          category: container
        annotations:
          summary: "Container {{`{{ $labels.name }}`}} is restarting"
          description: "Container has restarted {{`{{ $value }}`}} times in the last 15 minutes"