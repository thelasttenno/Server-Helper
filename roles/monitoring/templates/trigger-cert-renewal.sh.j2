#!/bin/bash
# Automated Certificate Renewal Trigger
# Called when certificates are about to expire

LOG_FILE=/var/log/auto-remediation.log

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] [CERT-RENEWAL] $1" | tee -a "$LOG_FILE"
}

log "Starting automated certificate renewal check"

# Run the remediation playbook
ansible-playbook {{ base_install_dir }}/ansible/playbooks/remediation.yml \
    -e "action=cert_renewal" \
    >> "$LOG_FILE" 2>&1

EXIT_CODE=$?

if [ $EXIT_CODE -eq 0 ]; then
    log "Certificate renewal completed successfully"

    # Notify Uptime Kuma
    {% if monitoring.uptime_kuma_push_url is defined and monitoring.uptime_kuma_push_url | length > 0 %}
    curl -s "{{ monitoring.uptime_kuma_push_url }}?status=up&msg=Certificates+renewed+successfully" > /dev/null 2>&1
    {% endif %}
else
    log "Certificate renewal failed (exit code: $EXIT_CODE)"

    # Send critical alert
    {% if monitoring.uptime_kuma_push_url is defined and monitoring.uptime_kuma_push_url | length > 0 %}
    curl -s "{{ monitoring.uptime_kuma_push_url }}?status=down&msg=Certificate+renewal+FAILED" > /dev/null 2>&1
    {% endif %}
fi

exit $EXIT_CODE