#!/bin/bash
# Automated Disk Cleanup Trigger
# Called when disk usage exceeds threshold

SEVERITY="${1:-warning}"
LOG_FILE=/var/log/auto-remediation.log

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] [DISK-CLEANUP] $1" | tee -a "$LOG_FILE"
}

# Get current disk usage
DISK_USAGE=$(df -h / | tail -1 | awk '{print $5}' | sed 's/%//')

log "Disk usage detected at ${DISK_USAGE}% - triggering cleanup (severity: $SEVERITY)"

# Run the remediation playbook
ansible-playbook {{ base_install_dir }}/ansible/playbooks/remediation.yml \
    -e "action=disk_cleanup" \
    -e "path=/" \
    -e "severity=$SEVERITY" \
    >> "$LOG_FILE" 2>&1

EXIT_CODE=$?

# Get disk usage after cleanup
DISK_USAGE_AFTER=$(df -h / | tail -1 | awk '{print $5}' | sed 's/%//')

if [ $EXIT_CODE -eq 0 ]; then
    FREED_SPACE=$((DISK_USAGE - DISK_USAGE_AFTER))
    log "Cleanup completed successfully. Usage: ${DISK_USAGE}% -> ${DISK_USAGE_AFTER}% (freed ${FREED_SPACE}%)"

    # Notify Uptime Kuma
    {% if monitoring.uptime_kuma_push_url is defined and monitoring.uptime_kuma_push_url | length > 0 %}
    curl -s "{{ monitoring.uptime_kuma_push_url }}?status=up&msg=Disk+cleanup+completed+-+freed+${FREED_SPACE}%25" > /dev/null 2>&1
    {% endif %}
else
    log "Cleanup failed (exit code: $EXIT_CODE). Current usage: ${DISK_USAGE_AFTER}%"

    # Send critical alert if still above threshold
    if [ "$DISK_USAGE_AFTER" -gt 90 ]; then
        {% if monitoring.uptime_kuma_push_url is defined and monitoring.uptime_kuma_push_url | length > 0 %}
        curl -s "{{ monitoring.uptime_kuma_push_url }}?status=down&msg=CRITICAL:+Disk+at+${DISK_USAGE_AFTER}%25+after+cleanup" > /dev/null 2>&1
        {% endif %}
    fi
fi

exit $EXIT_CODE