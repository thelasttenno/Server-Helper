---
# Monitoring Role - Main Tasks

- name: Create monitoring stack directory
  ansible.builtin.file:
    path: "{{ dockge_stacks_dir }}/monitoring"
    state: directory
    mode: '0755'

- name: Deploy monitoring stack (Netdata + Uptime Kuma)
  ansible.builtin.template:
    src: docker-compose.monitoring.yml.j2
    dest: "{{ dockge_stacks_dir }}/monitoring/compose.yaml"
    mode: '0644'

- name: Start monitoring stack
  community.docker.docker_compose:
    project_src: "{{ dockge_stacks_dir }}/monitoring"
    state: present
    pull: true

- name: Wait for Netdata to be ready
  ansible.builtin.uri:
    url: "http://localhost:{{ monitoring.netdata.port }}"
    status_code: 200
  register: netdata_health
  until: netdata_health.status == 200
  retries: 30
  delay: 2
  when: monitoring.netdata.enabled | default(true)

- name: Wait for Uptime Kuma to be ready
  ansible.builtin.uri:
    url: "http://localhost:{{ monitoring.uptime_kuma.port }}"
    status_code: 200
  register: uptime_kuma_health
  until: uptime_kuma_health.status == 200
  retries: 30
  delay: 2
  when: monitoring.uptime_kuma.enabled | default(true)

- name: Create Uptime Kuma configuration guide
  ansible.builtin.template:
    src: uptime_kuma_setup.md.j2
    dest: "{{ base_install_dir }}/uptime_kuma_setup.md"
    mode: '0644'

- name: Setup automated remediation
  import_tasks: remediation.yml
  when: monitoring.auto_remediation.enabled | default(true)

- name: Display monitoring access info
  ansible.builtin.debug:
    msg:
      - "Monitoring stack is ready!"
      - "Netdata: http://{{ ansible_default_ipv4.address }}:{{ monitoring.netdata.port }}"
      - "Uptime Kuma: http://{{ ansible_default_ipv4.address }}:{{ monitoring.uptime_kuma.port }}"
      - ""
      - "Automated Remediation: {{ 'ENABLED' if monitoring.auto_remediation.enabled | default(true) else 'DISABLED' }}"
      - "Webhook Handler: http://localhost:{{ monitoring.remediation_webhook_port | default(9090) }}"
      - ""
      - "Next steps:"
      - "1. Access Uptime Kuma and create admin account"
      - "2. Set up monitors for all services"
      - "3. Configure notification channels"
      - "4. See {{ base_install_dir }}/uptime_kuma_setup.md for detailed guide"
      - "5. Review automated remediation docs: /opt/ansible/docs/AUTOMATED_REMEDIATION.md"
