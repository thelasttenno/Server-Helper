# {{ ansible_managed }}
services:
  step-ca:
    image: smallstep/step-ca:{{ control_step_ca.version }}
    container_name: step-ca
    restart: unless-stopped
    ports:
      - "{{ control_step_ca.port }}:9443"
    env_file:
      - .env
    volumes:
      - step-ca-data:/home/step
      - ./init-ca.sh:/init-ca.sh:ro
    networks:
      - traefik-public
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.step-ca.rule=Host(`step-ca.{{ target_domain }}`)"
      - "traefik.http.routers.step-ca.entrypoints=websecure"
      - "traefik.http.routers.step-ca.tls.certresolver=letsencrypt"
      - "traefik.http.services.step-ca.loadbalancer.server.port=9443"
      - "traefik.http.services.step-ca.loadbalancer.server.scheme=https"
    healthcheck:
      test: ["CMD", "step", "ca", "health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

volumes:
  step-ca-data:

networks:
  traefik-public:
    external: true
