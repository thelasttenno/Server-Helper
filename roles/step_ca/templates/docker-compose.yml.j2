# Step-CA - Internal Certificate Authority
# Managed by Ansible - Server Helper
# Dockge compatible: /opt/stacks/step-ca/

services:
  step-ca:
    image: {{ step_ca_image }}:{{ step_ca_image_tag }}
    container_name: {{ step_ca_container_name }}
    restart: unless-stopped
    user: "1000:1000"
    ports:
      - "{{ step_ca_port }}:9000"
    volumes:
      - ./config:/home/step/config:ro
      - ./certs:/home/step/certs
      - ./secrets:/home/step/secrets:ro
      - ./db:/home/step/db
    environment:
      - DOCKER_STEPCA_INIT_NAME={{ step_ca_name }}
      - DOCKER_STEPCA_INIT_DNS_NAMES={{ step_ca_dns_names | join(',') }}
      - DOCKER_STEPCA_INIT_REMOTE_MANAGEMENT=true
    deploy:
      resources:
        limits:
          memory: {{ step_ca_memory_limit }}
          cpus: "{{ step_ca_cpu_limit }}"
    healthcheck:
      test: ["CMD", "step", "ca", "health", "--ca-url", "https://localhost:9000", "--root", "/home/step/certs/root_ca.crt"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
      - "traefik.enable=true"
      - "traefik.http.routers.step-ca.rule=Host(`step-ca.{{ target_domain | default('local') }}`)"
      - "traefik.http.routers.step-ca.entrypoints=websecure"
      - "traefik.http.routers.step-ca.tls=true"
      - "traefik.http.services.step-ca.loadbalancer.server.port=9000"
      - "traefik.http.services.step-ca.loadbalancer.server.scheme=https"
      - "traefik.http.services.step-ca.loadbalancer.serversTransport=step-ca-transport@file"

networks:
  default:
    name: {{ traefik_docker_network | default('traefik-public') }}
    external: true
