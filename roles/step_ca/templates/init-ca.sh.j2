#!/bin/bash
# {{ ansible_managed }}
# Step-CA initialization script
# Run this manually on first deployment: docker exec step-ca /init-ca.sh

set -euo pipefail

echo "Initializing Step-CA..."
step ca init \
  --name="{{ control_step_ca.ca_name }}" \
  --dns="step-ca.{{ target_domain }},{{ target_control_ip }},localhost" \
  --address=":9443" \
  --provisioner="{{ control_step_ca.provisioner_name }}" \
  --password-file=<(echo "{{ vault_step_ca_credentials.password }}")

# Add ACME provisioner
step ca provisioner add acme --type ACME

echo "Step-CA initialized successfully!"
echo "Root CA cert: /home/step/certs/root_ca.crt"
