# Step-CA Setup Guide

## Overview

Step-CA is your internal certificate authority for issuing TLS certificates to internal services.

**CA Name:** {{ step_ca_name }}
**CA URL:** https://step-ca.{{ target_domain | default('local') }}:{{ step_ca_port }}

## Installing the Root CA

### On Linux Servers (Automated)

Run on each target node:
```bash
# Download root CA
curl -k https://{{ control_node_ip | default('localhost') }}:{{ step_ca_port }}/root -o /tmp/root_ca.crt

# Install system-wide
sudo cp /tmp/root_ca.crt /usr/local/share/ca-certificates/step-ca-root.crt
sudo update-ca-certificates
```

### On Windows

1. Download: `https://step-ca.{{ target_domain | default('local') }}:{{ step_ca_port }}/root`
2. Double-click the certificate
3. Install Certificate > Local Machine > Trusted Root Certification Authorities

### On macOS

```bash
curl -k https://{{ control_node_ip | default('localhost') }}:{{ step_ca_port }}/root -o /tmp/root_ca.crt
sudo security add-trusted-cert -d -r trustRoot -k /Library/Keychains/System.keychain /tmp/root_ca.crt
```

## Installing step CLI

On any machine that needs to request certificates:

```bash
wget https://dl.smallstep.com/cli/docs-cli-install/latest/step-cli_amd64.deb
sudo dpkg -i step-cli_amd64.deb

# Bootstrap the CLI with your CA
step ca bootstrap --ca-url https://{{ control_node_ip | default('localhost') }}:{{ step_ca_port }} --fingerprint $(step certificate fingerprint {{ step_ca_stack_dir }}/certs/root_ca.crt)
```

## Requesting Certificates

### Interactive (with password)

```bash
step ca certificate myservice.{{ target_domain | default('local') }} server.crt server.key
```

### Using ACME (automatic)

```bash
# Using certbot with Step-CA ACME
certbot certonly --server https://{{ control_node_ip | default('localhost') }}:{{ step_ca_port }}/acme/{{ step_ca_acme_provisioner_name }}/directory \
    --standalone \
    -d myservice.{{ target_domain | default('local') }}
```

### For Docker containers

```bash
step ca certificate container.{{ target_domain | default('local') }} /certs/server.crt /certs/server.key \
    --ca-url https://step-ca:9000 \
    --root /certs/root_ca.crt \
    --provisioner {{ step_ca_provisioner_name }} \
    --password-file /secrets/password
```

## Traefik Integration

To use Step-CA with Traefik for automatic internal certificates:

1. Copy root CA to Traefik:
   ```bash
   cp {{ step_ca_stack_dir }}/certs/root_ca.crt /opt/stacks/traefik/certs/
   ```

2. Add to Traefik's `traefik.yml`:
   ```yaml
   certificatesResolvers:
     step-ca:
       acme:
         email: admin@{{ target_domain | default('local') }}
         storage: /letsencrypt/acme-step.json
         caServer: https://step-ca:9000/acme/{{ step_ca_acme_provisioner_name }}/directory
         tlsChallenge: {}
   ```

## Certificate Renewal

Certificates issued by Step-CA have short validity ({{ step_ca_default_cert_validity }} default).

For automatic renewal, use `step` CLI's renewal daemon:

```bash
step ca renew --daemon server.crt server.key
```

Or set up a systemd timer for periodic renewal.

## Important Files

| File | Location |
|------|----------|
| Root CA | `{{ step_ca_stack_dir }}/certs/root_ca.crt` |
| Intermediate CA | `{{ step_ca_stack_dir }}/certs/intermediate_ca.crt` |
| CA Config | `{{ step_ca_stack_dir }}/config/ca.json` |
| Database | `{{ step_ca_stack_dir }}/db/` |

---
Generated by Server Helper Ansible
