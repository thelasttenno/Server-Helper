---
# System Setup Role - Main Tasks
# Consolidated role for base system configuration and Docker installation

# ==============================================
# Hostname and Timezone
# ==============================================
- name: Set hostname
  ansible.builtin.hostname:
    name: "{{ target_hostname }}"
  when: target_hostname is defined

- name: Update /etc/hosts
  ansible.builtin.lineinfile:
    path: /etc/hosts
    regexp: '^127\.0\.1\.1'
    line: "127.0.1.1 {{ target_hostname }}"
    state: present
  when: target_hostname is defined

- name: Set timezone
  community.general.timezone:
    name: "{{ target_timezone }}"
  when: target_timezone is defined

- name: Set locale
  ansible.builtin.locale_gen:
    name: "{{ target_locale }}"
    state: present
  when: target_locale is defined

# ==============================================
# System Packages
# ==============================================
- name: Install required system packages
  ansible.builtin.apt:
    name:
      - apt-transport-https
      - ca-certificates
      - curl
      - wget
      - gnupg
      - lsb-release
      - software-properties-common
      - python3
      - python3-pip
      - git
      - nano
      - htop
      - net-tools
      - jq
      - tree
      - ncdu
      - cifs-utils
      - nfs-common
    state: present
    update_cache: true

# ==============================================
# Virtualization Support
# ==============================================
- name: Install QEMU guest agent for Proxmox/KVM virtualization
  ansible.builtin.apt:
    name: qemu-guest-agent
    state: present
  when: target_virtualization.qemu_guest_agent | default(false)

- name: Enable and start QEMU guest agent service
  ansible.builtin.service:
    name: qemu-guest-agent
    state: started
    enabled: true
  when: target_virtualization.qemu_guest_agent | default(false)

- name: Detect virtualization platform
  ansible.builtin.command: systemd-detect-virt
  register: virt_platform
  changed_when: false
  failed_when: false

- name: Display virtualization platform
  ansible.builtin.debug:
    msg: "Detected virtualization platform: {{ virt_platform.stdout }}"
  when: virt_platform.rc == 0

# ==============================================
# Docker Installation
# ==============================================
- name: Install Docker
  include_tasks: docker.yml

# ==============================================
# Directory Structure
# ==============================================
- name: Create base directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - "{{ target_base_dir }}"
    - "{{ target_base_dir }}/scripts"
    - "{{ target_dockge_base_dir }}"
    - "{{ target_dockge_stacks_dir }}"
    - "{{ target_dockge_data_dir }}"
    - /opt/backups
    - /var/log/server-helper

# ==============================================
# Log Rotation
# ==============================================
- name: Set up log rotation for server-helper logs
  ansible.builtin.copy:
    dest: /etc/logrotate.d/server-helper
    content: |
      /var/log/server-helper/*.log {
          daily
          rotate {{ target_logging.retention_days | default(30) }}
          compress
          delaycompress
          notifempty
          create 0640 root root
          sharedscripts
      }
    mode: '0644'

# ==============================================
# Performance Tuning
# ==============================================
- name: Optimize system performance (if configured)
  ansible.posix.sysctl:
    name: "{{ item.key }}"
    value: "{{ item.value }}"
    state: present
    sysctl_set: true
    reload: true
  loop:
    - { key: 'vm.swappiness', value: '10' }
    - { key: 'net.core.somaxconn', value: '1024' }
    - { key: 'net.ipv4.tcp_max_syn_backlog', value: '2048' }
  when: target_performance.tuning_enabled | default(false)

# ==============================================
# Version File
# ==============================================
- name: Copy version file
  ansible.builtin.copy:
    content: "1.0.0"
    dest: "{{ target_base_dir }}/VERSION"
    mode: '0644'

# ==============================================
# System Check
# ==============================================
- name: Check if reboot is required
  ansible.builtin.stat:
    path: /var/run/reboot-required
  register: reboot_required

- name: Display reboot notice
  ansible.builtin.debug:
    msg: "System reboot required. Please reboot at your convenience."
  when: reboot_required.stat.exists
