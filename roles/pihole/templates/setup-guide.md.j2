# Pi-hole Setup Guide

## Overview

Pi-hole is your network-wide DNS sinkhole that blocks ads and tracking domains.

{% if pihole_unbound_enabled %}
**Architecture:** Pi-hole â†’ Unbound (recursive DNS resolver)

This provides:
- No reliance on upstream DNS providers
- Full DNSSEC validation
- Enhanced privacy
{% endif %}

## Access

- **Web Interface:** https://pihole.{{ target_domain | default('local') }} or http://{{ control_node_ip | default('localhost') }}:{{ pihole_web_port }}/admin
- **DNS Server:** {{ control_node_ip | default('localhost') }}:{{ pihole_dns_port }}

## Configuring Clients

### Option 1: Router DNS (Recommended)

Set your router's DNS server to: `{{ control_node_ip | default('localhost') }}`

This applies Pi-hole filtering to all devices on your network.

### Option 2: Per-Device

Configure each device's DNS settings:
- Primary DNS: `{{ control_node_ip | default('localhost') }}`
- Secondary DNS: Leave blank or use `1.1.1.1` as fallback

### Option 3: DHCP (If Enabled)

{% if pihole_dhcp_enabled %}
Pi-hole DHCP is enabled:
- Range: {{ pihole_dhcp_start }} - {{ pihole_dhcp_end }}
- Router: {{ pihole_dhcp_router }}

Disable DHCP on your router to use Pi-hole's DHCP.
{% else %}
Pi-hole DHCP is not enabled. Enable it in the configuration if you want Pi-hole to assign IP addresses.
{% endif %}

## Adding Local DNS Records

### Via Ansible

Add to your configuration:
```yaml
pihole_custom_dns_records:
  - hostname: "myserver.local"
    ip: "192.168.1.100"
```

### Via Web Interface

1. Go to **Local DNS** > **DNS Records**
2. Add hostname and IP
3. Click **Add**

## Managing Blocklists

### Default Blocklists

Pi-hole includes default blocklists. You can add more:

1. Go to **Adlists**
2. Add URL of blocklist
3. Run `pihole -g` or click **Update Gravity**

### Recommended Additional Lists

```
https://raw.githubusercontent.com/StevenBlack/hosts/master/hosts
https://raw.githubusercontent.com/hagezi/dns-blocklists/main/domains/pro.txt
```

## Whitelisting Domains

If a site is blocked that shouldn't be:

1. Go to **Whitelist**
2. Add the domain
3. Choose **Exact whitelist** or **Regex whitelist**

## Statistics and Monitoring

- **Dashboard:** Overview of queries, blocked domains, clients
- **Query Log:** Real-time log of all DNS queries
- **Long-term data:** Historical graphs and statistics

## Maintenance

### Update Gravity (Blocklists)

```bash
docker exec pihole pihole -g
```

### Update Pi-hole

Pull the latest image and recreate:
```bash
cd {{ pihole_stack_dir }}
docker compose pull
docker compose up -d
```

### Backup Configuration

Important files to backup:
- `{{ pihole_stack_dir }}/pihole/` (settings, custom lists)
- `{{ pihole_stack_dir }}/dnsmasq.d/` (custom DNS config)

## Troubleshooting

### DNS Not Working

1. Check if Pi-hole container is running:
   ```bash
   docker ps | grep pihole
   ```

2. Test DNS resolution:
   ```bash
   dig @{{ control_node_ip | default('localhost') }} google.com
   ```

3. Check Pi-hole logs:
   ```bash
   docker logs pihole
   ```

### High Memory Usage

Reduce gravity database size by removing unused blocklists.

---
Generated by Server Helper Ansible
