# {{ ansible_managed }}
services:
  pihole:
    image: pihole/pihole:{{ control_dns.pihole_version }}
    container_name: pihole
    restart: unless-stopped
    ports:
      - "{{ control_dns.dns_port }}:53/tcp"
      - "{{ control_dns.dns_port }}:53/udp"
      - "{{ control_dns.pihole_port }}:80/tcp"
    environment:
      TZ: "{{ target_timezone }}"
      WEBPASSWORD: "{{ vault_pihole_password }}"
      PIHOLE_DNS_: "unbound#5335"
      DNSSEC: "{{ control_dns.dnssec | lower }}"
    volumes:
      - pihole-data:/etc/pihole
      - pihole-dnsmasq:/etc/dnsmasq.d
      - ./config/custom.list:/etc/pihole/custom.list:ro
      - ./config/05-custom-cname.conf:/etc/dnsmasq.d/05-custom-cname.conf:ro
    networks:
      - traefik-public
      - pihole-internal
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.pihole.rule=Host(`pihole.{{ target_domain }}`)"
      - "traefik.http.routers.pihole.entrypoints=websecure"
      - "traefik.http.routers.pihole.tls.certresolver=letsencrypt"
      - "traefik.http.services.pihole.loadbalancer.server.port=80"
      - "traefik.http.routers.pihole.middlewares=security-headers"
    depends_on:
      unbound:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "dig", "+short", "+norecurse", "+retry=0", "@127.0.0.1", "pi.hole"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  unbound:
    image: mvance/unbound:{{ control_dns.unbound_version }}
    container_name: unbound
    restart: unless-stopped
    volumes:
      - ./unbound/unbound.conf:/opt/unbound/etc/unbound/unbound.conf:ro
    networks:
      - pihole-internal
    healthcheck:
      test: ["CMD", "drill", "@127.0.0.1", "cloudflare.com"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

volumes:
  pihole-data:
  pihole-dnsmasq:

networks:
  traefik-public:
    external: true
  pihole-internal:
