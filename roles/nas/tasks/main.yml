# NAS Role - Mount Network Shares
# Supports CIFS/SMB and NFS shares with flexible configuration

---
- name: Ensure CIFS utilities are installed
  apt:
    name:
      - cifs-utils
      - nfs-common
    state: present

- name: Create NAS mount points
  file:
    path: "{{ item.mount }}"
    state: directory
    mode: '0755'
  loop: "{{ nas.shares }}"
  when: nas.shares is defined

- name: Create credential files for CIFS shares
  copy:
    dest: "/root/.nascreds_{{ item.mount | regex_replace('/', '_') }}"
    content: |
      username={{ item.username }}
      password={{ item.password }}
    mode: '0600'
    owner: root
    group: root
  loop: "{{ nas.shares }}"
  when: 
    - nas.shares is defined
    - item.username is defined
    - item.password is defined
  no_log: true  # Don't log credentials

- name: Mount CIFS/SMB shares
  mount:
    path: "{{ item.mount }}"
    src: "//{{ item.ip }}/{{ item.share }}"
    fstype: cifs
    opts: "credentials=/root/.nascreds_{{ item.mount | regex_replace('/', '_') }},{{ item.options | default('vers=3.0,_netdev,nofail') }}"
    state: mounted
  loop: "{{ nas.shares }}"
  when: 
    - nas.shares is defined
    - item.username is defined  # CIFS requires credentials
  register: cifs_mounts
  ignore_errors: yes  # Don't fail if NAS is temporarily unavailable

- name: Check mount status
  shell: mountpoint -q "{{ item.mount }}" && echo "mounted" || echo "not mounted"
  loop: "{{ nas.shares }}"
  when: nas.shares is defined
  register: mount_status
  changed_when: false

- name: Display mount status
  debug:
    msg: "{{ item.item.mount }}: {{ item.stdout }}"
  loop: "{{ mount_status.results }}"
  when: mount_status.results is defined

- name: Verify NAS connectivity
  wait_for:
    host: "{{ item.ip }}"
    port: 445  # SMB port
    timeout: 5
    state: started
  loop: "{{ nas.shares }}"
  when: nas.shares is defined
  register: nas_connectivity
  ignore_errors: yes

- name: Warn about unreachable NAS
  debug:
    msg: "⚠️  Warning: NAS {{ item.item.ip }} is not reachable"
  loop: "{{ nas_connectivity.results }}"
  when: 
    - nas_connectivity.results is defined
    - item.failed is defined
    - item.failed

- name: Create NAS health check script
  copy:
    dest: /opt/scripts/check-nas-mounts.sh
    content: |
      #!/bin/bash
      # NAS Health Check Script
      # Generated by Server Helper Ansible
      
      FAILED=0
      {% for share in nas.shares %}
      if ! mountpoint -q "{{ share.mount }}"; then
          echo "❌ {{ share.mount }} is not mounted"
          FAILED=1
          # Try to remount
          mount "{{ share.mount }}" 2>/dev/null
      else
          echo "✅ {{ share.mount }} is mounted"
      fi
      {% endfor %}
      
      exit $FAILED
    mode: '0755'
  when: nas.shares is defined

- name: Test NAS health check script
  command: /opt/scripts/check-nas-mounts.sh
  register: nas_health
  changed_when: false
  failed_when: false

- name: Display NAS health check results
  debug:
    msg: "{{ nas_health.stdout_lines }}"
  when: nas_health.stdout_lines is defined
