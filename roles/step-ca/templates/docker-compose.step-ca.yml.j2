# Smallstep CA - Internal Certificate Authority
# Provides ACME-compatible certificate issuance for internal services
# Deployed by Server Helper

version: '3.8'

services:
  step-ca:
    image: smallstep/step-ca:latest
    container_name: step-ca
    restart: unless-stopped
    ports:
      - "{{ step_ca.port }}:9000"
    volumes:
      - step-ca-data:/home/step
      - {{ step_ca.data_dir }}/config:/home/step/config:ro
      - {{ step_ca.data_dir }}/secrets:/home/step/secrets:ro
    environment:
      # CA initialization settings
      - DOCKER_STEPCA_INIT_NAME={{ step_ca.name }}
      - DOCKER_STEPCA_INIT_DNS_NAMES={{ step_ca.dns_names | join(',') }}
      - DOCKER_STEPCA_INIT_PROVISIONER_NAME={{ step_ca.provisioner_name }}
      - DOCKER_STEPCA_INIT_PASSWORD_FILE=/home/step/secrets/password
      - DOCKER_STEPCA_INIT_ACME=true
{% if step_ca.ssh.enabled | default(false) %}
      - DOCKER_STEPCA_INIT_SSH=true
{% endif %}
      - TZ={{ timezone | default('UTC') }}
    networks:
      - proxy
    healthcheck:
      test: ["CMD", "step", "ca", "health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
{% if step_ca.resources is defined %}
    deploy:
      resources:
        limits:
          memory: {{ step_ca.resources.memory | default('128M') }}
          cpus: '{{ step_ca.resources.cpu | default('0.5') }}'
{% endif %}
    labels:
      - "com.server-helper.service=step-ca"
      - "com.server-helper.description=Internal Certificate Authority"
{% if reverse_proxy.enabled | default(false) and reverse_proxy.type == 'traefik' %}
      # Traefik routing for Step CA (internal access)
      - "traefik.enable=true"
      - "traefik.http.routers.step-ca.rule=Host(`step-ca.{{ dns.private_domain | default('internal') }}`)"
      - "traefik.http.routers.step-ca.entrypoints=websecure"
      - "traefik.http.routers.step-ca.tls=true"
      - "traefik.http.services.step-ca.loadbalancer.server.port=9000"
      - "traefik.http.services.step-ca.loadbalancer.server.scheme=https"
      - "traefik.http.services.step-ca.loadbalancer.serversTransport=step-ca@file"
{% endif %}

volumes:
  step-ca-data:
    name: step-ca-data

networks:
  proxy:
    external: true
    name: proxy
