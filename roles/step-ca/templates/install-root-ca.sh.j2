#!/bin/bash
# Smallstep CA Root Certificate Installer
# Generated by Server Helper
#
# This script installs the internal CA root certificate on client devices
# so browsers/systems trust certificates issued by your Smallstep CA.

set -e

CA_URL="https://{{ ansible_host }}:{{ step_ca.port }}"
CERT_FILE="step-ca-root.crt"

echo "=============================================="
echo "Smallstep CA Root Certificate Installer"
echo "=============================================="
echo ""
echo "CA URL: ${CA_URL}"
echo ""

# Download root certificate
echo "[1/3] Downloading root certificate..."
curl -sSL -k "${CA_URL}/roots.pem" -o "${CERT_FILE}"

if [ ! -f "${CERT_FILE}" ]; then
    echo "ERROR: Failed to download root certificate"
    exit 1
fi

echo "[2/3] Certificate downloaded: ${CERT_FILE}"
echo ""

# Detect OS and install
detect_os() {
    if [ -f /etc/os-release ]; then
        . /etc/os-release
        echo "$ID"
    elif [ "$(uname)" == "Darwin" ]; then
        echo "macos"
    elif [ "$(uname -s)" == "MINGW"* ] || [ "$(uname -s)" == "CYGWIN"* ]; then
        echo "windows"
    else
        echo "unknown"
    fi
}

OS=$(detect_os)

echo "[3/3] Installing certificate for OS: ${OS}"
echo ""

case "${OS}" in
    ubuntu|debian)
        echo "Installing on Debian/Ubuntu..."
        sudo cp "${CERT_FILE}" /usr/local/share/ca-certificates/step-ca-root.crt
        sudo update-ca-certificates
        echo "Certificate installed to system trust store."
        ;;

    centos|rhel|fedora|rocky|almalinux)
        echo "Installing on RHEL/CentOS/Fedora..."
        sudo cp "${CERT_FILE}" /etc/pki/ca-trust/source/anchors/step-ca-root.crt
        sudo update-ca-trust
        echo "Certificate installed to system trust store."
        ;;

    alpine)
        echo "Installing on Alpine..."
        sudo cp "${CERT_FILE}" /usr/local/share/ca-certificates/step-ca-root.crt
        sudo update-ca-certificates
        echo "Certificate installed to system trust store."
        ;;

    arch|manjaro)
        echo "Installing on Arch/Manjaro..."
        sudo trust anchor --store "${CERT_FILE}"
        echo "Certificate installed to system trust store."
        ;;

    macos)
        echo "Installing on macOS..."
        sudo security add-trusted-cert -d -r trustRoot -k /Library/Keychains/System.keychain "${CERT_FILE}"
        echo "Certificate installed to System Keychain."
        echo ""
        echo "NOTE: You may need to restart your browser."
        ;;

    windows)
        echo "Installing on Windows..."
        echo ""
        echo "Run the following command in PowerShell (as Administrator):"
        echo ""
        echo "  certutil -addstore -f \"ROOT\" ${CERT_FILE}"
        echo ""
        echo "Or double-click the certificate file and:"
        echo "  1. Click 'Install Certificate'"
        echo "  2. Select 'Local Machine'"
        echo "  3. Select 'Place all certificates in the following store'"
        echo "  4. Click 'Browse' and select 'Trusted Root Certification Authorities'"
        echo "  5. Click 'Next' and 'Finish'"
        ;;

    *)
        echo "Unknown OS. Manual installation required."
        echo ""
        echo "Certificate file: ${CERT_FILE}"
        echo ""
        echo "General instructions:"
        echo "  - Copy certificate to system CA trust store"
        echo "  - Run system command to update CA certificates"
        echo ""
        echo "Common locations:"
        echo "  - Debian/Ubuntu: /usr/local/share/ca-certificates/"
        echo "  - RHEL/CentOS: /etc/pki/ca-trust/source/anchors/"
        echo "  - Alpine: /usr/local/share/ca-certificates/"
        ;;
esac

echo ""
echo "=============================================="
echo "Installation Complete!"
echo "=============================================="
echo ""
echo "Your system now trusts certificates from:"
echo "  CA Name: {{ step_ca.name }}"
echo "  CA URL:  ${CA_URL}"
echo ""
echo "Services using this CA will have valid HTTPS."
echo "=============================================="
