---
# Smallstep CA - Internal Certificate Authority
# Provides ACME-compatible certificate issuance for internal services

- name: Create Step CA directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: "0755"
    owner: root
    group: root
  loop:
    - "{{ step_ca.data_dir }}"
    - "{{ step_ca.data_dir }}/config"
    - "{{ step_ca.data_dir }}/secrets"
    - "{{ step_ca.data_dir }}/certs"
  when: step_ca.enabled | default(false)

- name: Create Step CA password file
  ansible.builtin.copy:
    content: "{{ vault_step_ca_password }}"
    dest: "{{ step_ca.data_dir }}/secrets/password"
    mode: "0600"
    owner: root
    group: root
  when: step_ca.enabled | default(false)
  no_log: true

- name: Create Step CA provisioner password file
  ansible.builtin.copy:
    content: "{{ vault_step_ca_provisioner_password | default(vault_step_ca_password) }}"
    dest: "{{ step_ca.data_dir }}/secrets/provisioner-password"
    mode: "0600"
    owner: root
    group: root
  when: step_ca.enabled | default(false)
  no_log: true

- name: Deploy Step CA Docker Compose
  ansible.builtin.template:
    src: docker-compose.step-ca.yml.j2
    dest: "{{ step_ca.data_dir }}/docker-compose.yml"
    mode: "0644"
  when: step_ca.enabled | default(false)
  notify: Restart Step CA

- name: Deploy Step CA configuration
  ansible.builtin.template:
    src: ca.json.j2
    dest: "{{ step_ca.data_dir }}/config/ca.json"
    mode: "0644"
  when: step_ca.enabled | default(false)
  notify: Restart Step CA

- name: Deploy Step CA defaults configuration
  ansible.builtin.template:
    src: defaults.json.j2
    dest: "{{ step_ca.data_dir }}/config/defaults.json"
    mode: "0644"
  when: step_ca.enabled | default(false)
  notify: Restart Step CA

- name: Start Step CA
  community.docker.docker_compose_v2:
    project_src: "{{ step_ca.data_dir }}"
    state: present
  when: step_ca.enabled | default(false)

- name: Wait for Step CA to be ready
  ansible.builtin.uri:
    url: "https://localhost:{{ step_ca.port }}/health"
    validate_certs: false
    status_code: 200
  register: step_ca_health
  retries: 30
  delay: 2
  until: step_ca_health.status == 200
  when: step_ca.enabled | default(false)

- name: Export root CA certificate
  ansible.builtin.shell: |
    docker exec step-ca step ca root > {{ step_ca.data_dir }}/certs/root_ca.crt
  args:
    creates: "{{ step_ca.data_dir }}/certs/root_ca.crt"
  when: step_ca.enabled | default(false)

- name: Install root CA to system trust store
  ansible.builtin.copy:
    src: "{{ step_ca.data_dir }}/certs/root_ca.crt"
    dest: /usr/local/share/ca-certificates/step-ca-root.crt
    remote_src: true
    mode: "0644"
  when: step_ca.enabled | default(false)
  notify: Update CA certificates

- name: Create client installation script
  ansible.builtin.template:
    src: install-root-ca.sh.j2
    dest: "{{ step_ca.data_dir }}/install-root-ca.sh"
    mode: "0755"
  when: step_ca.enabled | default(false)

- name: Add firewall rule for Step CA
  community.general.ufw:
    rule: allow
    port: "{{ step_ca.port }}"
    proto: tcp
    comment: "Step CA ACME server"
  when:
    - step_ca.enabled | default(false)
    - security.ufw_enabled | default(true)

- name: Display Step CA information
  ansible.builtin.debug:
    msg: |
      =====================================================
      Smallstep CA Deployed Successfully!
      =====================================================

      ACME Directory URL: https://{{ ansible_host }}:{{ step_ca.port }}/acme/acme/directory

      Root CA Certificate: {{ step_ca.data_dir }}/certs/root_ca.crt

      Client Installation Script: {{ step_ca.data_dir }}/install-root-ca.sh

      To install root CA on client devices, run:
        curl -sSL https://{{ ansible_host }}:{{ step_ca.port }}/roots.pem -o step-ca-root.crt
        # Then follow OS-specific installation instructions

      =====================================================
  when: step_ca.enabled | default(false)
