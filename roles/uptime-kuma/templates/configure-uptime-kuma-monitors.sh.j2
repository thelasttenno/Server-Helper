#!/bin/bash
# Uptime Kuma Monitor Configuration Helper
# Generated by Ansible - Server Helper v1.0.0

set -e

GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${GREEN}╔════════════════════════════════════════╗${NC}"
echo -e "${GREEN}║  Uptime Kuma Monitor Setup Helper     ║${NC}"
echo -e "${GREEN}╚════════════════════════════════════════╝${NC}"
echo ""

# Check if Uptime Kuma is running
if ! curl -fsS http://localhost:{{ uptime_kuma.port }} > /dev/null 2>&1; then
    echo -e "${YELLOW}⚠ Uptime Kuma is not running!${NC}"
    echo "Start it with: cd {{ dockge.data_dir }}/stacks/uptime-kuma && docker compose up -d"
    exit 1
fi

echo -e "${BLUE}This script will help you configure Uptime Kuma push monitors.${NC}"
echo ""
echo "Prerequisites:"
echo "  1. You must have created an admin account in Uptime Kuma UI"
echo "  2. Access Uptime Kuma at: http://{{ ansible_host }}:{{ uptime_kuma.port }}"
echo ""

read -p "Have you completed initial setup? (y/N): " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "Please complete initial setup first."
    echo "Guide available at: /root/uptime-kuma-setup-guide.md"
    exit 0
fi

echo ""
echo -e "${GREEN}Step 1: Create Push Monitors${NC}"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""
echo "In Uptime Kuma UI, create these push monitors:"
echo ""
echo "1. System Health (Heartbeat: 5 minutes)"
echo "2. Backup Status (Heartbeat: 24 hours)"
echo "3. Security Scan (Heartbeat: 7 days)"
echo "4. NAS Health (Heartbeat: 5 minutes)"
echo "5. Dockge Health (Heartbeat: 5 minutes)"
echo "6. Update Status (Heartbeat: 24 hours)"
echo ""

# Optional: Netdata alarms
read -p "Do you want to setup Netdata alarm monitoring? (y/N): " -n 1 -r
echo
SETUP_NETDATA=false
if [[ $REPLY =~ ^[Yy]$ ]]; then
    SETUP_NETDATA=true
    echo ""
    echo "Also create these push monitors in Uptime Kuma:"
    echo ""
    echo "7. Netdata CPU Alert (Heartbeat: 5 minutes)"
    echo "8. Netdata RAM Alert (Heartbeat: 5 minutes)"
    echo "9. Netdata Disk Alert (Heartbeat: 5 minutes)"
    echo "10. Netdata Docker Alert (Heartbeat: 5 minutes)"
    echo ""
fi

echo ""
echo "After creating each monitor, copy its push URL."
echo ""
read -p "Press Enter when you have created all push monitors..."

echo ""
echo -e "${GREEN}Step 2: Enter Push URLs${NC}"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""

# Collect URLs
declare -A URLS

read -p "System Health push URL: " URLS[system]
read -p "Backup Status push URL: " URLS[backup]
read -p "Security Scan push URL: " URLS[security]
read -p "NAS Health push URL: " URLS[nas]
read -p "Dockge Health push URL: " URLS[dockge]
read -p "Update Status push URL: " URLS[update]

if [ "$SETUP_NETDATA" = true ]; then
    read -p "Netdata CPU Alert push URL: " URLS[cpu]
    read -p "Netdata RAM Alert push URL: " URLS[ram]
    read -p "Netdata Disk Alert push URL: " URLS[disk]
    read -p "Netdata Docker Alert push URL: " URLS[docker]
fi

echo ""
echo -e "${GREEN}Step 3: Update Vault${NC}"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""

echo "Add these lines to your vault (ansible-vault edit group_vars/vault.yml):"
echo ""
echo "vault_uptime_kuma_push_urls:"
echo "  system: \"${URLS[system]}\""
echo "  backup: \"${URLS[backup]}\""
echo "  security: \"${URLS[security]}\""
echo "  nas: \"${URLS[nas]}\""
echo "  dockge: \"${URLS[dockge]}\""
echo "  update: \"${URLS[update]}\""

if [ "$SETUP_NETDATA" = true ]; then
    echo ""
    echo "For Netdata alarms, update group_vars/all.yml:"
    echo ""
    echo "netdata:"
    echo "  alarms:"
    echo "    uptime_kuma_urls:"
    echo "      cpu: \"${URLS[cpu]}\""
    echo "      ram: \"${URLS[ram]}\""
    echo "      disk: \"${URLS[disk]}\""
    echo "      docker: \"${URLS[docker]}\""
fi

echo ""
echo -e "${GREEN}Step 4: Apply Configuration${NC}"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""
echo "After updating vault, re-run the setup playbook:"
echo ""
echo "  ansible-playbook playbooks/setup.yml"
echo ""

echo -e "${GREEN}✓ Configuration complete!${NC}"
echo ""
echo "Your push monitors will start receiving heartbeats within their intervals."
echo ""

# Offer to edit vault now
read -p "Would you like to edit vault now? (y/N): " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    ansible-vault edit group_vars/vault.yml
fi

exit 0
