# {{ ansible_managed }}
services:
  traefik:
    image: traefik:{{ control_traefik.version }}
    container_name: traefik
    restart: unless-stopped
    ports:
      - "{{ control_traefik.http_port }}:80"
      - "{{ control_traefik.https_port }}:443"
      - "{{ control_traefik.dashboard_port }}:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik.yml:/traefik.yml:ro
      - ./dynamic-config.yml:/dynamic-config.yml:ro
      - ./acme:/acme
    networks:
      - traefik-public
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.dashboard.rule=Host(`traefik.{{ target_domain }}`)"
      - "traefik.http.routers.dashboard.entrypoints=websecure"
      - "traefik.http.routers.dashboard.tls.certresolver=letsencrypt"
      - "traefik.http.routers.dashboard.service=api@internal"
      - "traefik.http.routers.dashboard.middlewares=auth,security-headers"
      - "traefik.http.middlewares.auth.basicauth.users={{ _traefik_htpasswd }}"
    healthcheck:
      test: ["CMD", "traefik", "healthcheck", "--ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

networks:
  traefik-public:
    external: true
