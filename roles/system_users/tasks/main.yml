---
# System Users Role - User Account Management
# Creates users, configures sudo, SSH keys, and disables root

- name: Create system admin user
  ansible.builtin.user:
    name: "{{ system_users.admin_user }}"
    password: "{{ system_users.admin_password | password_hash('sha512') }}"
    shell: /bin/bash
    groups: "{{ system_users.admin_groups | join(',') }}"
    append: yes
    create_home: yes
    state: present
  when: system_users.create_admin_user | default(false)

- name: Set up .ssh directory for admin user
  ansible.builtin.file:
    path: "/home/{{ system_users.admin_user }}/.ssh"
    state: directory
    owner: "{{ system_users.admin_user }}"
    group: "{{ system_users.admin_user }}"
    mode: '0700'
  when: system_users.create_admin_user | default(false)

- name: Add SSH public key for admin user
  ansible.builtin.authorized_key:
    user: "{{ system_users.admin_user }}"
    key: "{{ system_users.admin_ssh_key }}"
    state: present
  when:
    - system_users.create_admin_user | default(false)
    - system_users.admin_ssh_key is defined
    - system_users.admin_ssh_key | length > 0

- name: Configure passwordless sudo for admin user
  ansible.builtin.lineinfile:
    path: /etc/sudoers.d/{{ system_users.admin_user }}
    line: "{{ system_users.admin_user }} ALL=(ALL) NOPASSWD:ALL"
    state: present
    mode: '0440'
    create: yes
    validate: 'visudo -cf %s'
  when:
    - system_users.create_admin_user | default(false)
    - system_users.admin_passwordless_sudo | default(true)

- name: Configure sudo with password for admin user
  ansible.builtin.lineinfile:
    path: /etc/sudoers.d/{{ system_users.admin_user }}
    line: "{{ system_users.admin_user }} ALL=(ALL:ALL) ALL"
    state: present
    mode: '0440'
    create: yes
    validate: 'visudo -cf %s'
  when:
    - system_users.create_admin_user | default(false)
    - not (system_users.admin_passwordless_sudo | default(true))

- name: Create additional users
  ansible.builtin.user:
    name: "{{ item.name }}"
    password: "{{ item.password | password_hash('sha512') }}"
    shell: "{{ item.shell | default('/bin/bash') }}"
    groups: "{{ item.groups | default([]) | join(',') }}"
    append: yes
    create_home: yes
    state: present
  loop: "{{ system_users.additional_users }}"
  when: system_users.additional_users is defined

- name: Set up .ssh directories for additional users
  ansible.builtin.file:
    path: "/home/{{ item.name }}/.ssh"
    state: directory
    owner: "{{ item.name }}"
    group: "{{ item.name }}"
    mode: '0700'
  loop: "{{ system_users.additional_users }}"
  when: system_users.additional_users is defined

- name: Add SSH keys for additional users
  ansible.builtin.authorized_key:
    user: "{{ item.name }}"
    key: "{{ item.ssh_key }}"
    state: present
  loop: "{{ system_users.additional_users }}"
  when:
    - system_users.additional_users is defined
    - item.ssh_key is defined
    - item.ssh_key | length > 0

- name: Lock root account password
  ansible.builtin.user:
    name: root
    password_lock: yes
  when: system_users.disable_root_password | default(true)

- name: Remove root password from shadow file
  ansible.builtin.command: passwd -l root
  changed_when: false
  when: system_users.disable_root_password | default(true)

- name: Ensure sudo group exists
  ansible.builtin.group:
    name: sudo
    state: present

- name: Ensure wheel group exists
  ansible.builtin.group:
    name: wheel
    state: present

- name: Configure sudo group in sudoers
  ansible.builtin.lineinfile:
    path: /etc/sudoers
    regexp: '^%sudo'
    line: '%sudo   ALL=(ALL:ALL) ALL'
    state: present
    validate: 'visudo -cf %s'

- name: Display user creation summary
  ansible.builtin.debug:
    msg:
      - "════════════════════════════════════════"
      - "User Account Configuration Complete"
      - "════════════════════════════════════════"
      - "Admin user: {{ system_users.admin_user | default('not created') }}"
      - "Root password: {{ 'locked' if system_users.disable_root_password | default(true) else 'active' }}"
      - "SSH key auth: {{ 'configured' if system_users.admin_ssh_key is defined else 'password only' }}"
      - "Passwordless sudo: {{ 'enabled' if system_users.admin_passwordless_sudo | default(true) else 'disabled' }}"
      - "════════════════════════════════════════"
