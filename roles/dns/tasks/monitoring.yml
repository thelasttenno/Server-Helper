---
# DNS Monitoring Configuration
# Integrates Pi-hole with Grafana, Netdata, and Uptime Kuma

- name: Create Pi-hole exporter for Prometheus
  when: logging.grafana.enabled | default(false)
  block:
    - name: Deploy Pi-hole exporter sidecar
      ansible.builtin.template:
        src: docker-compose.dns-exporter.yml.j2
        dest: "{{ dns.stack_dir }}/docker-compose.exporter.yml"
        mode: '0644'
      notify: restart dns stack

    - name: Create Prometheus scrape config for Pi-hole
      ansible.builtin.template:
        src: prometheus-pihole.yml.j2
        dest: "{{ logging.stack_dir }}/prometheus/pihole.yml"
        mode: '0644'
      when: logging.stack_dir is defined

- name: Add DNS monitoring to Uptime Kuma (info only)
  when: uptime_kuma.enabled | default(false)
  ansible.builtin.debug:
    msg:
      - "Add these monitors to Uptime Kuma:"
      - "  1. Pi-hole Health: HTTP - http://{{ ansible_default_ipv4.address }}:{{ dns.pihole.port }}/admin/"
      - "  2. DNS Resolution: DNS - {{ ansible_default_ipv4.address }} (query: google.com)"
      - "  3. Internal DNS: DNS - {{ ansible_default_ipv4.address }} (query: grafana.internal)"

- name: Create Netdata Pi-hole monitoring config
  when: netdata.enabled | default(false)
  ansible.builtin.template:
    src: netdata-pihole.conf.j2
    dest: /opt/dockge/stacks/netdata/pihole.conf
    mode: '0644'
  notify: restart netdata
