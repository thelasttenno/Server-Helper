#!/bin/bash
# Lynis Security Scan Script
# Generated by Ansible - Server Helper v1.0.0

set -euo pipefail

# Configuration
SCAN_DIR="{{ lynis.scan_dir }}"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
REPORT_FILE="$SCAN_DIR/lynis-report-$TIMESTAMP.txt"
SUMMARY_FILE="$SCAN_DIR/lynis-summary-$TIMESTAMP.txt"
LATEST_LINK="$SCAN_DIR/lynis-report-latest.txt"

{% if vault_uptime_kuma_push_urls.security | default('') | length > 0 %}
UPTIME_KUMA_URL="{{ vault_uptime_kuma_push_urls.security }}"
{% else %}
UPTIME_KUMA_URL=""
{% endif %}

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo "=================================================================="
echo "  Lynis Security Scan - $(date)"
echo "=================================================================="
echo ""

# Run Lynis scan
echo "Running Lynis security audit..."
lynis audit system \
    --quiet \
    --no-colors \
    --report-file "$REPORT_FILE" \
    2>&1 | tee "$SUMMARY_FILE"

# Extract key metrics
HARDENING_INDEX=$(grep "Hardening index" "$REPORT_FILE" | awk '{print $4}' | tr -d '[]')
WARNINGS=$(grep -c "^warning\[\]=" "$REPORT_FILE" 2>/dev/null || echo "0")
SUGGESTIONS=$(grep -c "^suggestion\[\]=" "$REPORT_FILE" 2>/dev/null || echo "0")

# Create summary
cat > "$SUMMARY_FILE" << EOF
Lynis Security Scan Summary
Date: $(date)
Hostname: $(hostname)

Hardening Index: ${HARDENING_INDEX}/100
Warnings: $WARNINGS
Suggestions: $SUGGESTIONS

Top Issues:
$(grep "^warning\[\]=" "$REPORT_FILE" | head -5 | sed 's/warning\[\]=/  - /')

Report Location: $REPORT_FILE

To view full report:
  sudo lynis show report
  sudo cat $REPORT_FILE
EOF

# Display summary
cat "$SUMMARY_FILE"

# Update latest symlink
ln -sf "$REPORT_FILE" "$LATEST_LINK"

# Send notification to Uptime Kuma
if [ -n "$UPTIME_KUMA_URL" ]; then
    if [ "$WARNINGS" -eq 0 ]; then
        STATUS="up"
        MESSAGE="Security scan complete: ${HARDENING_INDEX}/100 hardening, $SUGGESTIONS suggestions"
    elif [ "$WARNINGS" -lt 5 ]; then
        STATUS="up"
        MESSAGE="Security scan: ${HARDENING_INDEX}/100 hardening, $WARNINGS warnings, $SUGGESTIONS suggestions"
    else
        STATUS="down"
        MESSAGE="Security issues detected: $WARNINGS warnings, ${HARDENING_INDEX}/100 hardening"
    fi
    
    ENCODED_MSG=$(echo -n "$MESSAGE" | jq -sRr @uri 2>/dev/null || echo "$MESSAGE")
    curl -fsS -m 10 "${UPTIME_KUMA_URL}?status=${STATUS}&msg=${ENCODED_MSG}" >/dev/null 2>&1 || true
fi

# Cleanup old reports (keep last {{ lynis.retention_days }} days)
find "$SCAN_DIR" -name "lynis-report-*.txt" -mtime +{{ lynis.retention_days }} -delete 2>/dev/null || true
find "$SCAN_DIR" -name "lynis-summary-*.txt" -mtime +{{ lynis.retention_days }} -delete 2>/dev/null || true

echo ""
echo "=================================================================="
echo "  Scan complete! Report saved to:"
echo "  $REPORT_FILE"
echo "=================================================================="
echo ""
echo "Next scan: $(systemctl list-timers lynis-scan.timer --no-pager | grep lynis-scan | awk '{print $1, $2, $3}')"

exit 0
