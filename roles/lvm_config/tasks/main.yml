---
# Role: lvm_config â€” Expand LVM volumes to use 100% free space
# Auto-skipped on LXC containers via lvm_skip flag

- name: Skip LVM config message
  ansible.builtin.debug:
    msg: "Skipping LVM configuration (lvm_skip={{ lvm_skip }})"
  when: lvm_skip | bool

- name: Check for LVM volumes
  ansible.builtin.command: lvs --noheadings -o lv_name,vg_name
  register: lvm_volumes
  changed_when: false
  failed_when: false
  when: not (lvm_skip | bool)

- name: Extend logical volumes to 100% free space
  ansible.builtin.command: >
    lvextend -l +100%FREE /dev/{{ item.split()[1] }}/{{ item.split()[0] }}
  loop: "{{ lvm_volumes.stdout_lines | default([]) }}"
  when:
    - not (lvm_skip | bool)
    - lvm_volumes.rc == 0
    - lvm_volumes.stdout_lines | length > 0
  register: lvm_extend_result
  changed_when: "'successfully resized' in lvm_extend_result.stdout | default('')"
  failed_when: false
  notify: Resize filesystem

- name: Detect filesystem type for each volume
  ansible.builtin.command: >
    blkid -o value -s TYPE /dev/{{ item.split()[1] }}/{{ item.split()[0] }}
  loop: "{{ lvm_volumes.stdout_lines | default([]) }}"
  register: lvm_fs_types
  changed_when: false
  when:
    - not (lvm_skip | bool)
    - lvm_volumes.rc == 0
    - lvm_volumes.stdout_lines | length > 0
