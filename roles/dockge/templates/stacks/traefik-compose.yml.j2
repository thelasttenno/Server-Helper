# Traefik Stack - Reverse Proxy with Hybrid Certificate Management
# Deployed via Dockge
#
# Certificate Resolvers:
#   - letsencrypt: For PUBLIC domains (via DNS-01 challenge with Cloudflare)
#   - step-ca: For INTERNAL domains (via self-hosted Smallstep CA)
#
# Privacy: Cloudflare is DNS-ONLY mode (no traffic proxying)

version: '3.8'

services:
  traefik:
    image: traefik:v3.0
    container_name: traefik
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
{% if reverse_proxy.traefik.dashboard_enabled | default(false) %}
      - "{{ reverse_proxy.traefik.dashboard_port | default(8080) }}:8080"
{% endif %}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - traefik-certs:/letsencrypt
      - traefik-config:/etc/traefik
{% if step_ca.enabled | default(false) %}
      - {{ step_ca.data_dir | default('/opt/step-ca') }}/certs:/step-ca-certs:ro
{% endif %}
    command:
      # ===========================================
      # PROVIDERS
      # ===========================================
      # Docker provider - auto-discover containers
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
      - --providers.docker.network=proxy

      # File provider - for dynamic configuration
      - --providers.file.directory=/etc/traefik/dynamic
      - --providers.file.watch=true

      # ===========================================
      # ENTRYPOINTS
      # ===========================================
      # HTTP entrypoint (redirects to HTTPS)
      - --entrypoints.web.address=:80
{% if reverse_proxy.force_https | default(true) %}
      - --entrypoints.web.http.redirections.entrypoint.to=websecure
      - --entrypoints.web.http.redirections.entrypoint.scheme=https
      - --entrypoints.web.http.redirections.entrypoint.permanent=true
{% endif %}

      # HTTPS entrypoint
      - --entrypoints.websecure.address=:443
      - --entrypoints.websecure.http.tls=true

      # ===========================================
      # CERTIFICATE RESOLVERS
      # ===========================================
{% if certificates.public.enabled | default(true) %}
      # Let's Encrypt (for PUBLIC domains)
      # Uses DNS-01 challenge via Cloudflare for privacy
      - --certificatesresolvers.letsencrypt.acme.email={{ certificates.public.email | default(reverse_proxy.email) }}
      - --certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json
{% if certificates.public.challenge == 'dns-01' %}
      # DNS-01 Challenge (recommended for privacy + wildcards)
      - --certificatesresolvers.letsencrypt.acme.dnschallenge=true
      - --certificatesresolvers.letsencrypt.acme.dnschallenge.provider={{ certificates.public.dns_provider | default('cloudflare') }}
      - --certificatesresolvers.letsencrypt.acme.dnschallenge.resolvers=1.1.1.1:53,8.8.8.8:53
      - --certificatesresolvers.letsencrypt.acme.dnschallenge.delaybeforecheck=10
{% elif certificates.public.challenge == 'tls-alpn-01' %}
      # TLS-ALPN-01 Challenge (requires port 443 open)
      - --certificatesresolvers.letsencrypt.acme.tlschallenge=true
{% else %}
      # HTTP-01 Challenge (requires port 80 open)
      - --certificatesresolvers.letsencrypt.acme.httpchallenge=true
      - --certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web
{% endif %}
{% if certificates.public.staging | default(false) %}
      # Use Let's Encrypt staging for testing (avoids rate limits)
      - --certificatesresolvers.letsencrypt.acme.caserver=https://acme-staging-v02.api.letsencrypt.org/directory
{% endif %}
{% endif %}

{% if step_ca.enabled | default(false) %}
      # Smallstep CA (for INTERNAL domains)
      # Self-hosted, fully private certificate authority
      - --certificatesresolvers.step-ca.acme.email={{ certificates.internal.email | default('admin@' ~ dns.private_domain | default('internal')) }}
      - --certificatesresolvers.step-ca.acme.storage=/letsencrypt/step-ca-acme.json
      - --certificatesresolvers.step-ca.acme.caserver=https://{{ step_ca.dns_names[0] | default('step-ca') }}:{{ step_ca.port | default(9000) }}/acme/acme/directory
      - --certificatesresolvers.step-ca.acme.tlschallenge=true
      # Trust the Smallstep CA certificate
      - --certificatesresolvers.step-ca.acme.certificatesDuration=720
{% endif %}

      # ===========================================
      # API & DASHBOARD
      # ===========================================
{% if reverse_proxy.traefik.dashboard_enabled | default(false) %}
      - --api.dashboard=true
{% if reverse_proxy.traefik.dashboard_insecure | default(false) %}
      - --api.insecure=true
{% else %}
      - --api.insecure=false
{% endif %}
{% endif %}

      # ===========================================
      # LOGGING
      # ===========================================
      - --log.level={{ reverse_proxy.traefik.log_level | default('INFO') }}
      - --accesslog=true
      - --accesslog.format=json

      # ===========================================
      # SECURITY
      # ===========================================
{% if step_ca.enabled | default(false) %}
      # Trust Smallstep CA for backend connections
      - --serverstransport.rootcas=/step-ca-certs/root_ca.crt
{% endif %}

    environment:
      - TZ={{ timezone | default('UTC') }}
{% if certificates.public.enabled | default(true) and certificates.public.challenge == 'dns-01' %}
{% if certificates.public.dns_provider | default('cloudflare') == 'cloudflare' %}
      # Cloudflare DNS API credentials (DNS-only, no traffic proxying)
      - CF_DNS_API_TOKEN={{ vault_cloudflare_dns_api_token }}
{% elif certificates.public.dns_provider == 'route53' %}
      # AWS Route53 credentials
      - AWS_ACCESS_KEY_ID={{ vault_aws_access_key_id }}
      - AWS_SECRET_ACCESS_KEY={{ vault_aws_secret_access_key }}
      - AWS_HOSTED_ZONE_ID={{ certificates.public.route53_zone_id }}
{% elif certificates.public.dns_provider == 'digitalocean' %}
      # DigitalOcean DNS credentials
      - DO_AUTH_TOKEN={{ vault_digitalocean_api_token }}
{% elif certificates.public.dns_provider == 'namecheap' %}
      # Namecheap DNS credentials
      - NAMECHEAP_API_USER={{ vault_namecheap_api_user }}
      - NAMECHEAP_API_KEY={{ vault_namecheap_api_key }}
{% elif certificates.public.dns_provider == 'godaddy' %}
      # GoDaddy DNS credentials
      - GODADDY_API_KEY={{ vault_godaddy_api_key }}
      - GODADDY_API_SECRET={{ vault_godaddy_api_secret }}
{% endif %}
{% endif %}

    labels:
      - "traefik.enable=true"
      - "com.server-helper.service=traefik"
      - "com.server-helper.description=Reverse Proxy with Hybrid Certificates"

{% if reverse_proxy.traefik.dashboard_enabled | default(false) and not reverse_proxy.traefik.dashboard_insecure | default(false) %}
      # Dashboard routing (internal domain only)
      - "traefik.http.routers.dashboard.rule=Host(`traefik.{{ dns.private_domain | default('internal') }}`)"
      - "traefik.http.routers.dashboard.service=api@internal"
      - "traefik.http.routers.dashboard.entrypoints=websecure"
{% if step_ca.enabled | default(false) %}
      - "traefik.http.routers.dashboard.tls.certresolver=step-ca"
{% else %}
      - "traefik.http.routers.dashboard.tls=true"
{% endif %}
      # Dashboard authentication
      - "traefik.http.routers.dashboard.middlewares=dashboard-auth"
      - "traefik.http.middlewares.dashboard-auth.basicauth.users={{ vault_traefik_dashboard_auth | default('admin:$$apr1$$placeholder') }}"
{% endif %}

      # Security headers middleware (apply to all routes)
      - "traefik.http.middlewares.security-headers.headers.stsSeconds=31536000"
      - "traefik.http.middlewares.security-headers.headers.stsIncludeSubdomains=true"
      - "traefik.http.middlewares.security-headers.headers.stsPreload=true"
      - "traefik.http.middlewares.security-headers.headers.forceSTSHeader=true"
      - "traefik.http.middlewares.security-headers.headers.contentTypeNosniff=true"
      - "traefik.http.middlewares.security-headers.headers.browserXssFilter=true"
      - "traefik.http.middlewares.security-headers.headers.referrerPolicy=strict-origin-when-cross-origin"
      - "traefik.http.middlewares.security-headers.headers.frameDeny=true"

    networks:
      - proxy
      - monitoring

    healthcheck:
      test: ["CMD", "traefik", "healthcheck"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

volumes:
  traefik-certs:
    name: traefik-certs
  traefik-config:
    name: traefik-config

networks:
  proxy:
    external: true
    name: proxy
  monitoring:
    external: true
    name: monitoring
