# Traefik Dynamic Configuration
# Auto-generated by Server Helper
#
# This file configures routing for all services with automatic
# certificate resolver selection based on domain type:
#   - Public domains (*.tennogen.ca, publicpower.org) → Let's Encrypt
#   - Internal domains (*.internal) → Smallstep CA

# =============================================================================
# TLS OPTIONS
# =============================================================================
tls:
  options:
    default:
      minVersion: VersionTLS12
      cipherSuites:
        - TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384
        - TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384
        - TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256
        - TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256
        - TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305
        - TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305

    modern:
      minVersion: VersionTLS13

{% if step_ca.enabled | default(false) %}
  # Trust Smallstep CA for internal service connections
  stores:
    default:
      defaultCertificate:
        certFile: /step-ca-certs/root_ca.crt
{% endif %}

# =============================================================================
# SERVERS TRANSPORTS (for backend connections)
# =============================================================================
{% if step_ca.enabled | default(false) %}
http:
  serversTransports:
    # Transport for services using Smallstep CA certificates
    step-ca:
      rootCAs:
        - /step-ca-certs/root_ca.crt
      serverName: "*.{{ dns.private_domain | default('internal') }}"

    # Transport for services using self-signed certs (insecure)
    insecure-skip-verify:
      insecureSkipVerify: true
{% endif %}

# =============================================================================
# MIDDLEWARES
# =============================================================================
http:
  middlewares:
    # Security headers for all routes
    security-headers:
      headers:
        stsSeconds: 31536000
        stsIncludeSubdomains: true
        stsPreload: true
        forceSTSHeader: true
        contentTypeNosniff: true
        browserXssFilter: true
        referrerPolicy: strict-origin-when-cross-origin
        frameDeny: true
        customResponseHeaders:
          X-Robots-Tag: "noindex, nofollow"

    # Rate limiting
    rate-limit:
      rateLimit:
        average: 100
        burst: 50

    # Compress responses
    compress:
      compress: {}

    # Internal only - block external access
    internal-only:
      ipWhiteList:
        sourceRange:
          - "127.0.0.1/32"
          - "10.0.0.0/8"
          - "172.16.0.0/12"
          - "192.168.0.0/16"

    # Redirect HTTP to HTTPS
    https-redirect:
      redirectScheme:
        scheme: https
        permanent: true

# =============================================================================
# ROUTERS & SERVICES - PUBLIC DOMAINS
# =============================================================================
{% if services is defined %}
{% for service_name, service_config in services.items() if service_config.enabled | default(false) and service_config.public | default(false) %}
  routers:
    {{ service_name }}-public:
      rule: "Host(`{{ service_config.domain }}`)"
      entryPoints:
        - websecure
      service: {{ service_name }}
      tls:
        certResolver: letsencrypt
{% if service_config.wildcard | default(false) %}
        domains:
          - main: "{{ service_config.domain.split('.')[1:] | join('.') }}"
            sans:
              - "*.{{ service_config.domain.split('.')[1:] | join('.') }}"
{% endif %}
      middlewares:
        - security-headers
{% if service_config.rate_limit | default(false) %}
        - rate-limit
{% endif %}
{% if service_config.compress | default(true) %}
        - compress
{% endif %}

  services:
    {{ service_name }}:
      loadBalancer:
        servers:
          - url: "http://{{ service_config.container | default(service_name) }}:{{ service_config.port }}"
{% if service_config.health_check | default(false) %}
        healthCheck:
          path: {{ service_config.health_check_path | default('/health') }}
          interval: 30s
          timeout: 5s
{% endif %}

{% endfor %}
{% endif %}

# =============================================================================
# ROUTERS & SERVICES - INTERNAL DOMAINS
# =============================================================================
{% if services is defined %}
{% for service_name, service_config in services.items() if service_config.enabled | default(false) and not service_config.public | default(false) %}
  routers:
    {{ service_name }}-internal:
      rule: "Host(`{{ service_name }}.{{ dns.private_domain | default('internal') }}`)"
      entryPoints:
        - websecure
      service: {{ service_name }}
{% if step_ca.enabled | default(false) %}
      tls:
        certResolver: step-ca
{% else %}
      tls: {}
{% endif %}
      middlewares:
        - security-headers
        - internal-only

  services:
    {{ service_name }}:
      loadBalancer:
        servers:
          - url: "http://{{ service_config.container | default(service_name) }}:{{ service_config.port }}"

{% endfor %}
{% endif %}

# =============================================================================
# DEFAULT INTERNAL SERVICES
# =============================================================================
{% if dockge.enabled | default(true) %}
  routers:
    dockge-internal:
      rule: "Host(`dockge.{{ dns.private_domain | default('internal') }}`)"
      entryPoints:
        - websecure
      service: dockge
{% if step_ca.enabled | default(false) %}
      tls:
        certResolver: step-ca
{% else %}
      tls: {}
{% endif %}
      middlewares:
        - security-headers
        - internal-only

  services:
    dockge:
      loadBalancer:
        servers:
          - url: "http://dockge:{{ dockge.port | default(5001) }}"
{% endif %}

{% if netdata.enabled | default(true) %}
  routers:
    netdata-internal:
      rule: "Host(`netdata.{{ dns.private_domain | default('internal') }}`)"
      entryPoints:
        - websecure
      service: netdata
{% if step_ca.enabled | default(false) %}
      tls:
        certResolver: step-ca
{% else %}
      tls: {}
{% endif %}
      middlewares:
        - security-headers
        - internal-only

  services:
    netdata:
      loadBalancer:
        servers:
          - url: "http://netdata:{{ netdata.port | default(19999) }}"
{% endif %}

{% if uptime_kuma.enabled | default(true) %}
  routers:
    uptime-kuma-internal:
      rule: "Host(`uptime-kuma.{{ dns.private_domain | default('internal') }}`) || Host(`status.{{ dns.private_domain | default('internal') }}`)"
      entryPoints:
        - websecure
      service: uptime-kuma
{% if step_ca.enabled | default(false) %}
      tls:
        certResolver: step-ca
{% else %}
      tls: {}
{% endif %}
      middlewares:
        - security-headers
        - internal-only

  services:
    uptime-kuma:
      loadBalancer:
        servers:
          - url: "http://uptime-kuma:{{ uptime_kuma.port | default(3001) }}"
{% endif %}

{% if grafana.enabled | default(false) %}
  routers:
    grafana-internal:
      rule: "Host(`grafana.{{ dns.private_domain | default('internal') }}`)"
      entryPoints:
        - websecure
      service: grafana
{% if step_ca.enabled | default(false) %}
      tls:
        certResolver: step-ca
{% else %}
      tls: {}
{% endif %}
      middlewares:
        - security-headers
        - internal-only

  services:
    grafana:
      loadBalancer:
        servers:
          - url: "http://grafana:3000"
{% endif %}

{% if authentik.enabled | default(false) %}
  routers:
    authentik-internal:
      rule: "Host(`auth.{{ dns.private_domain | default('internal') }}`) || Host(`authentik.{{ dns.private_domain | default('internal') }}`)"
      entryPoints:
        - websecure
      service: authentik
{% if step_ca.enabled | default(false) %}
      tls:
        certResolver: step-ca
{% else %}
      tls: {}
{% endif %}
      middlewares:
        - security-headers

  services:
    authentik:
      loadBalancer:
        servers:
          - url: "http://authentik-server:9000"
{% endif %}
