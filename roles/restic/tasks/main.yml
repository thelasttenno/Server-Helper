---
# Role: restic â€” Install Restic, deploy backup/check scripts, set up systemd timers

- name: Set restic architecture
  ansible.builtin.set_fact:
    _restic_arch: "{{ 'amd64' if ansible_architecture == 'x86_64' else 'arm64' if ansible_architecture == 'aarch64' else ansible_architecture }}"

- name: Check current restic version
  ansible.builtin.command: restic version
  register: _restic_current
  changed_when: false
  failed_when: false

- name: Install restic from GitHub releases
  when: _restic_current.rc != 0 or ('restic ' + restic_version) not in (_restic_current.stdout | default(''))
  block:
    - name: Ensure bzip2 is installed
      ansible.builtin.apt:
        name: bzip2
        state: present

    - name: Download restic binary
      ansible.builtin.get_url:
        url: "https://github.com/restic/restic/releases/download/v{{ restic_version }}/restic_{{ restic_version }}_linux_{{ _restic_arch }}.bz2"
        dest: "/tmp/restic_{{ restic_version }}.bz2"
        mode: "0644"

    - name: Extract and install restic binary
      ansible.builtin.shell: |
        bunzip2 -f /tmp/restic_{{ restic_version }}.bz2
        mv -f /tmp/restic_{{ restic_version }} /usr/local/bin/restic
        chmod 0755 /usr/local/bin/restic

    - name: Verify restic installation
      ansible.builtin.command: restic version
      changed_when: false

- name: Create Restic config directory
  ansible.builtin.file:
    path: /etc/restic
    state: directory
    owner: root
    group: root
    mode: "0700"

- name: Create Restic log directory
  ansible.builtin.file:
    path: /var/log/restic
    state: directory
    owner: root
    group: root
    mode: "0700"

- name: Deploy Restic environment file
  ansible.builtin.template:
    src: restic-env.j2
    dest: /etc/restic/restic.env
    owner: root
    group: root
    mode: "0600"
  no_log: true

- name: Deploy Restic excludes file
  ansible.builtin.template:
    src: restic-excludes.j2
    dest: /etc/restic/excludes.txt
    owner: root
    group: root
    mode: "0644"

- name: Deploy Restic backup script
  ansible.builtin.template:
    src: restic-backup.sh.j2
    dest: /usr/local/bin/restic-backup.sh
    owner: root
    group: root
    mode: "0755"

- name: Deploy Restic check script
  ansible.builtin.template:
    src: restic-check.sh.j2
    dest: /usr/local/bin/restic-check.sh
    owner: root
    group: root
    mode: "0755"

- name: Deploy Restic backup systemd service
  ansible.builtin.template:
    src: restic-backup.service.j2
    dest: /etc/systemd/system/restic-backup.service
    owner: root
    group: root
    mode: "0644"
  notify: Reload systemd

- name: Deploy Restic backup systemd timer
  ansible.builtin.template:
    src: restic-backup.timer.j2
    dest: /etc/systemd/system/restic-backup.timer
    owner: root
    group: root
    mode: "0644"
  notify:
    - Reload systemd
    - Start backup timer

- name: Deploy Restic check systemd service
  ansible.builtin.template:
    src: restic-check.service.j2
    dest: /etc/systemd/system/restic-check.service
    owner: root
    group: root
    mode: "0644"
  notify: Reload systemd

- name: Deploy Restic check systemd timer
  ansible.builtin.template:
    src: restic-check.timer.j2
    dest: /etc/systemd/system/restic-check.timer
    owner: root
    group: root
    mode: "0644"
  notify:
    - Reload systemd
    - Start check timer

- name: Deploy Restic verify script
  ansible.builtin.template:
    src: restic-verify.sh.j2
    dest: /usr/local/bin/restic-verify.sh
    owner: root
    group: root
    mode: "0755"

- name: Deploy Restic verify systemd service
  ansible.builtin.template:
    src: restic-verify.service.j2
    dest: /etc/systemd/system/restic-verify.service
    owner: root
    group: root
    mode: "0644"
  notify: Reload systemd

- name: Deploy Restic verify systemd timer (monthly)
  ansible.builtin.template:
    src: restic-verify.timer.j2
    dest: /etc/systemd/system/restic-verify.timer
    owner: root
    group: root
    mode: "0644"
  notify:
    - Reload systemd
    - Start verify timer

- name: Enable Restic timers
  ansible.builtin.systemd:
    name: "{{ item }}"
    enabled: true
    state: started
    daemon_reload: true
  loop:
    - restic-backup.timer
    - restic-check.timer
    - restic-verify.timer
