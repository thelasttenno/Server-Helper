#!/bin/bash
# {{ ansible_managed }}
# Restic backup script with metrics, notifications, and stale lock cleanup

set -euo pipefail

LOG_FILE="/var/log/restic/backup-$(date +%Y%m%d_%H%M%S).log"
METRICS_FILE="/var/log/restic/metrics.json"
BACKUP_STATUS="success"
BACKUP_MSG=""
START_TS=$(date +%s)

# Source environment
source /etc/restic/restic.env

echo "Starting backup at $(date)" | tee "${LOG_FILE}"

# Clear stale locks from previous crashed runs
restic unlock --remove-all 2>/dev/null || true

# Initialize repository if needed
restic snapshots &>/dev/null || restic init 2>&1 | tee -a "${LOG_FILE}"

# Run backup
if restic backup \
{% for path in target_restic.backup_paths %}
  {{ path }} \
{% endfor %}
  --exclude-file=/etc/restic/excludes.txt \
  --hostname "{{ inventory_hostname }}" \
  --compression auto \
  --verbose 2>&1 | tee -a "${LOG_FILE}"; then
    BACKUP_MSG="Backup completed successfully"
else
    BACKUP_STATUS="fail"
    BACKUP_MSG="Backup FAILED"
fi

# Apply retention policy
if [[ "$BACKUP_STATUS" == "success" ]]; then
    restic forget \
      --keep-daily {{ target_restic.retention.keep_daily }} \
      --keep-weekly {{ target_restic.retention.keep_weekly }} \
      --keep-monthly {{ target_restic.retention.keep_monthly }} \
      --keep-yearly {{ target_restic.retention.keep_yearly }} \
      --prune 2>&1 | tee -a "${LOG_FILE}" || true
fi

echo "${BACKUP_MSG} at $(date)" | tee -a "${LOG_FILE}"

# Collect metrics
END_TS=$(date +%s)
DURATION=$((END_TS - START_TS))
TOTAL_SIZE=0
SNAPSHOT_COUNT=0

if [[ "$BACKUP_STATUS" == "success" ]]; then
    TOTAL_SIZE=$(restic stats --json latest 2>/dev/null | python3 -c "import sys,json; print(json.load(sys.stdin).get('total_size',0))" 2>/dev/null || echo 0)
    SNAPSHOT_COUNT=$(restic snapshots --json 2>/dev/null | python3 -c "import sys,json; print(len(json.load(sys.stdin)))" 2>/dev/null || echo 0)
fi

# Write metrics (JSONL â€” one line per run)
python3 -c "
import json, sys
print(json.dumps({
    'hostname': '{{ inventory_hostname }}',
    'timestamp': '$(date -Iseconds)',
    'duration_seconds': $DURATION,
    'total_size_bytes': $TOTAL_SIZE,
    'snapshot_count': $SNAPSHOT_COUNT,
    'status': '$BACKUP_STATUS'
}))
" >> "${METRICS_FILE}" 2>/dev/null || true

# Push to Uptime Kuma (health check heartbeat)
{% if vault_uptime_kuma_push_urls.backup | default('') | length > 0 %}
PUSH_URL="{{ vault_uptime_kuma_push_urls.backup }}"
if [[ "$BACKUP_STATUS" == "success" ]]; then
    curl -fsS -m 10 "${PUSH_URL}?status=up&msg=OK&ping=" >/dev/null 2>&1 || true
else
    curl -fsS -m 10 "${PUSH_URL}?status=down&msg=FAIL&ping=" >/dev/null 2>&1 || true
fi
{% endif %}

# Send notification on failure
if [[ "$BACKUP_STATUS" == "fail" ]]; then
    server-helper-notify "Backup FAILED" "Backup failed on {{ inventory_hostname }} after ${DURATION}s. Check: journalctl -u restic-backup.service" 2>/dev/null || true
fi

# Cleanup old logs (keep last 30)
ls -t /var/log/restic/backup-*.log 2>/dev/null | tail -n +31 | xargs -r rm
