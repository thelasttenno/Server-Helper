#!/bin/bash
# Restic backup script
# Managed by Ansible - Server Helper

set -euo pipefail

# Load environment
source {{ restic_script_dir }}/restic.env

# Logging
LOG_FILE="{{ restic_log_dir }}/backup-$(date +%Y%m%d-%H%M%S).log"
exec > >(tee -a "$LOG_FILE") 2>&1

echo "========================================="
echo "Restic Backup Started: $(date)"
echo "Host: $(hostname)"
echo "========================================="

{% if restic_pre_backup_script %}
# Pre-backup hook
echo "Running pre-backup script..."
{{ restic_pre_backup_script }}
{% endif %}

# Run backup with nice/ionice for lower priority
echo "Starting backup..."
nice -n {{ restic_nice_level }} ionice -c {{ restic_ionice_class }} -n {{ restic_ionice_level }} \
    restic backup \
    --verbose \
    --exclude-file={{ restic_script_dir }}/excludes.txt \
    --tag "scheduled" \
    --tag "$(hostname)" \
{% for path in restic_backup_paths %}
    "{{ path }}"{% if not loop.last %} \{% endif %}

{% endfor %}

BACKUP_EXIT=$?

if [ $BACKUP_EXIT -ne 0 ]; then
    echo "ERROR: Backup failed with exit code $BACKUP_EXIT"
{% if restic_notify_on_failure and restic_notify_url %}
    curl -s -X POST "{{ restic_notify_url }}" \
        -H "Content-Type: application/json" \
        -d "{\"text\": \"Restic backup FAILED on $(hostname) at $(date)\"}" || true
{% endif %}
    exit $BACKUP_EXIT
fi

echo "Backup completed successfully"

{% if restic_prune_enabled %}
# Apply retention policy
echo "Applying retention policy..."
restic forget \
    --verbose \
    --keep-last {{ restic_retention_keep_last }} \
    --keep-daily {{ restic_retention_keep_daily }} \
    --keep-weekly {{ restic_retention_keep_weekly }} \
    --keep-monthly {{ restic_retention_keep_monthly }} \
    --keep-yearly {{ restic_retention_keep_yearly }} \
    --prune

echo "Retention policy applied"
{% endif %}

{% if restic_post_backup_script %}
# Post-backup hook
echo "Running post-backup script..."
{{ restic_post_backup_script }}
{% endif %}

# Show latest snapshots
echo ""
echo "Latest snapshots:"
restic snapshots --last 5

echo ""
echo "========================================="
echo "Restic Backup Completed: $(date)"
echo "========================================="

# Cleanup old logs (keep last 30 days)
find {{ restic_log_dir }} -name "backup-*.log" -mtime +30 -delete 2>/dev/null || true
