#!/bin/bash
# Restic Backup Script
# Generated by Server Helper Ansible v1.0.0

set -euo pipefail

# Logging
LOG_FILE="/var/log/restic/backup-$(date +%Y%m%d).log"
exec > >(tee -a "$LOG_FILE") 2>&1

echo "=================================================="
echo "Restic Backup Started: $(date)"
echo "=================================================="

# Backup function
backup_to_repo() {
    local repo="$1"
    local repo_name="$2"
    shift 2
    local env_vars=("$@")
    
    echo ""
    echo "Backing up to: $repo_name"
    echo "--------------------------------------------------"
    
    # Set environment variables
    for var in "${env_vars[@]}"; do
        export "$var"
    done
    
    # Run backup
    if restic -r "$repo" backup \
{% for path in restic.backup_paths %}
        "{{ path }}" \
{% endfor %}
{% for pattern in restic.exclude_patterns | default([]) %}
        --exclude "{{ pattern }}" \
{% endfor %}
        --tag "server-helper" \
        --tag "$(hostname)" \
        --verbose; then
        
        echo "✓ Backup successful"
        
        # Apply retention policy
        echo "Applying retention policy..."
        restic -r "$repo" forget \
            --keep-daily {{ restic.retention.keep_daily }} \
            --keep-weekly {{ restic.retention.keep_weekly }} \
            --keep-monthly {{ restic.retention.keep_monthly }} \
{% if restic.retention.keep_yearly is defined %}
            --keep-yearly {{ restic.retention.keep_yearly }} \
{% endif %}
            --prune \
            --verbose
        
        echo "✓ Retention policy applied"
        
        # Send success heartbeat to Uptime Kuma
{% if restic.uptime_kuma_push_url %}
        curl -fsS -m 10 "{{ restic.uptime_kuma_push_url }}?status=up&msg=${repo_name}-backup-success" >/dev/null 2>&1 || true
{% endif %}
        
        return 0
    else
        echo "✗ Backup failed"
        
        # Send failure heartbeat to Uptime Kuma
{% if restic.uptime_kuma_push_url %}
        curl -fsS -m 10 "{{ restic.uptime_kuma_push_url }}?status=down&msg=${repo_name}-backup-failed" >/dev/null 2>&1 || true
{% endif %}
        
        return 1
    fi
}

# Track overall status
FAILED=0

{% if restic.destinations.nas.enabled %}
# Backup to NAS
backup_to_repo \
    "{{ restic.destinations.nas.path }}" \
    "NAS" \
    "RESTIC_PASSWORD={{ restic.destinations.nas.password }}" \
    || FAILED=1
{% endif %}

{% if restic.destinations.s3.enabled %}
# Backup to S3
backup_to_repo \
    "s3:{{ restic.destinations.s3.endpoint }}/{{ restic.destinations.s3.bucket }}" \
    "S3" \
    "RESTIC_PASSWORD={{ restic.destinations.s3.password }}" \
    "AWS_ACCESS_KEY_ID={{ restic.destinations.s3.access_key }}" \
    "AWS_SECRET_ACCESS_KEY={{ restic.destinations.s3.secret_key }}" \
    || FAILED=1
{% endif %}

{% if restic.destinations.b2.enabled %}
# Backup to B2
backup_to_repo \
    "b2:{{ restic.destinations.b2.bucket }}" \
    "B2" \
    "RESTIC_PASSWORD={{ restic.destinations.b2.password }}" \
    "B2_ACCOUNT_ID={{ restic.destinations.b2.account_id }}" \
    "B2_ACCOUNT_KEY={{ restic.destinations.b2.account_key }}" \
    || FAILED=1
{% endif %}

{% if restic.destinations.local.enabled %}
# Backup to Local
backup_to_repo \
    "{{ restic.destinations.local.path }}" \
    "Local" \
    "RESTIC_PASSWORD={{ restic.destinations.local.password }}" \
    || FAILED=1
{% endif %}

echo ""
echo "=================================================="
echo "Restic Backup Completed: $(date)"
if [ $FAILED -eq 0 ]; then
    echo "Status: SUCCESS"
else
    echo "Status: FAILED (check logs above)"
fi
echo "=================================================="

exit $FAILED
