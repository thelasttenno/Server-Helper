#!/bin/bash
# {{ ansible_managed }}
# Restic repository check script

set -euo pipefail

LOG_FILE="/var/log/restic/check-$(date +%Y%m%d_%H%M%S).log"

source /etc/restic/restic.env

echo "Starting repository check at $(date)" | tee "${LOG_FILE}"

if restic check --verbose 2>&1 | tee -a "${LOG_FILE}"; then
    echo "Repository check completed at $(date)" | tee -a "${LOG_FILE}"
else
    echo "Repository check FAILED at $(date)" | tee -a "${LOG_FILE}"
    server-helper-notify "Restic Check FAILED" "Repository integrity check failed on {{ inventory_hostname }}. Check: journalctl -u restic-check.service" 2>/dev/null || true
fi

# Cleanup old logs (keep last 10)
ls -t /var/log/restic/check-*.log 2>/dev/null | tail -n +11 | xargs -r rm
