---
# Role: swap â€” Create swap file and set swappiness
# Auto-skipped on LXC containers via swap_skip flag

- name: Skip swap message
  ansible.builtin.debug:
    msg: "Skipping swap configuration (swap_skip={{ swap_skip }})"
  when: swap_skip | bool

- name: Check if swap file exists
  ansible.builtin.stat:
    path: /swapfile
  register: swap_file_check
  when: not (swap_skip | bool)

- name: Create swap file
  ansible.builtin.command: >
    fallocate -l {{ swap_size_gb }}G /swapfile
  when:
    - not (swap_skip | bool)
    - not swap_file_check.stat.exists | default(false)

- name: Set swap file permissions
  ansible.builtin.file:
    path: /swapfile
    owner: root
    group: root
    mode: "0600"
  when: not (swap_skip | bool)

- name: Format swap file
  ansible.builtin.command: mkswap /swapfile
  when:
    - not (swap_skip | bool)
    - not swap_file_check.stat.exists | default(false)

- name: Enable swap file
  ansible.builtin.command: swapon /swapfile
  when:
    - not (swap_skip | bool)
    - not swap_file_check.stat.exists | default(false)

- name: Add swap to fstab
  ansible.builtin.lineinfile:
    path: /etc/fstab
    regexp: '^/swapfile'
    line: '/swapfile none swap sw 0 0'
    state: present
  when: not (swap_skip | bool)

- name: Set swappiness
  ansible.posix.sysctl:
    name: vm.swappiness
    value: "10"
    sysctl_set: true
    state: present
    reload: true
  when: not (swap_skip | bool)
