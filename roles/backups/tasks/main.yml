---
# Backups Role - Main Tasks (Restic)

- name: Install Restic
  ansible.builtin.apt:
    name: restic
    state: present

- name: Create backup script directory
  ansible.builtin.file:
    path: "{{ base_install_dir }}/scripts"
    state: directory
    mode: '0755'

- name: Create Restic environment file
  ansible.builtin.template:
    src: restic_env.j2
    dest: "{{ base_install_dir }}/scripts/restic.env"
    mode: '0600'
  no_log: true

- name: Create backup script
  ansible.builtin.template:
    src: backup.sh.j2
    dest: "{{ base_install_dir }}/scripts/backup.sh"
    mode: '0755'

- name: Initialize Restic repositories
  ansible.builtin.shell: |
    source {{ base_install_dir }}/scripts/restic.env
    {{ item.init_command }}
  args:
    executable: /bin/bash
  loop: "{{ restic_repos }}"
  register: restic_init
  failed_when: false
  changed_when: "'created restic repository' in restic_init.stdout"
  no_log: true

- name: Create systemd service for backups
  ansible.builtin.template:
    src: backup.service.j2
    dest: /etc/systemd/system/server-helper-backup.service
    mode: '0644'

- name: Create systemd timer for backups
  ansible.builtin.template:
    src: backup.timer.j2
    dest: /etc/systemd/system/server-helper-backup.timer
    mode: '0644'

- name: Enable and start backup timer
  ansible.builtin.systemd:
    name: server-helper-backup.timer
    state: started
    enabled: true
    daemon_reload: true

- name: Create backup test script
  ansible.builtin.template:
    src: test_backup.sh.j2
    dest: "{{ base_install_dir }}/scripts/test_backup.sh"
    mode: '0755'

- name: Display backup info
  ansible.builtin.debug:
    msg:
      - "Backup system configured with Restic!"
      - "Schedule: {{ backups.schedule }}"
      - "Enabled destinations:"
{% for dest, config in backups.destinations.items() %}
{% if config.enabled | default(false) %}
      - "  - {{ dest | upper }}"
{% endif %}
{% endfor %}
      - ""
      - "To run backup manually: sudo {{ base_install_dir }}/scripts/backup.sh"
      - "To test backup: sudo {{ base_install_dir }}/scripts/test_backup.sh"
      - "To list backups: RESTIC_REPOSITORY=<repo> RESTIC_PASSWORD=<password> restic snapshots"
