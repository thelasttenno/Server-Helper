#!/bin/bash
# Server Helper - Backup Test Script
# Tests all configured Restic repositories

set -euo pipefail

source {{ base_install_dir }}/scripts/restic.env

echo "Testing Restic Backup Configuration"
echo "===================================="
echo ""

test_repo() {
    local name="$1"
    local repo="$2"
    
    echo -n "Testing $name... "
    export RESTIC_REPOSITORY="$repo"
    
    if restic snapshots >/dev/null 2>&1; then
        echo "✓ OK"
        restic stats --mode raw-data
        return 0
    else
        echo "✗ FAILED"
        return 1
    fi
}

{% if backups.destinations.local.enabled | default(false) %}
test_repo "LOCAL" "$RESTIC_REPO_LOCAL"
echo ""
{% endif %}

{% if backups.destinations.nas.enabled | default(false) %}
test_repo "NAS" "$RESTIC_REPO_NAS"
echo ""
{% endif %}

{% if backups.destinations.s3.enabled | default(false) %}
test_repo "S3" "$RESTIC_REPO_S3"
echo ""
{% endif %}

{% if backups.destinations.b2.enabled | default(false) %}
test_repo "B2" "$RESTIC_REPO_B2"
echo ""
{% endif %}

{% if backups.destinations.sftp.enabled | default(false) %}
test_repo "SFTP" "$RESTIC_REPO_SFTP"
echo ""
{% endif %}

echo "===================================="
echo "Test complete!"
