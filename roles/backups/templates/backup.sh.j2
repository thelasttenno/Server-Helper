#!/bin/bash
# Server Helper v1.0.0 - Backup Script (Restic)
# Generated: {{ ansible_date_time.iso8601 }}

set -euo pipefail

# Load environment
source {{ base_install_dir }}/scripts/restic.env

# Logging
LOG_FILE="/var/log/server-helper-backup.log"
exec 1> >(tee -a "$LOG_FILE")
exec 2>&1

echo "=========================================="
echo "Server Helper Backup Started"
echo "Time: $(date '+%Y-%m-%d %H:%M:%S')"
echo "=========================================="

# Function to send Uptime Kuma notification
notify_uptime_kuma() {
    local status="$1"
    local message="${2:-}"
    
    if [ -n "${UPTIME_KUMA_BACKUP_URL:-}" ]; then
        curl -fsS -m 10 "${UPTIME_KUMA_BACKUP_URL}?status=${status}&msg=${message}" >/dev/null 2>&1 || true
    fi
}

# Function to backup to a repository
backup_to_repo() {
    local repo_name="$1"
    local repo_var="$2"
    
    echo ""
    echo "----------------------------------------"
    echo "Backing up to: $repo_name"
    echo "----------------------------------------"
    
    export RESTIC_REPOSITORY="${!repo_var}"
    
    # Backup
    restic backup \
{% for path in backups.include_paths %}
        "{{ path }}" \
{% endfor %}
{% for pattern in backups.exclude_patterns %}
        --exclude "{{ pattern }}" \
{% endfor %}
        --tag "server-helper" \
        --tag "automated" \
        --verbose
    
    # Forget old snapshots and prune
    restic forget \
        --keep-daily {{ backups.retention.keep_daily }} \
        --keep-weekly {{ backups.retention.keep_weekly }} \
        --keep-monthly {{ backups.retention.keep_monthly }} \
        --keep-yearly {{ backups.retention.keep_yearly }} \
        --prune
    
    # Check repository health
    restic check --read-data-subset=5%
    
    echo "✓ Backup to $repo_name completed successfully"
}

# Track overall success
OVERALL_SUCCESS=true

# Backup to all enabled destinations
{% if backups.destinations.local.enabled | default(false) %}
if ! backup_to_repo "LOCAL" "RESTIC_REPO_LOCAL"; then
    echo "✗ LOCAL backup failed!"
    OVERALL_SUCCESS=false
fi
{% endif %}

{% if backups.destinations.nas.enabled | default(false) %}
if ! backup_to_repo "NAS" "RESTIC_REPO_NAS"; then
    echo "✗ NAS backup failed!"
    OVERALL_SUCCESS=false
fi
{% endif %}

{% if backups.destinations.s3.enabled | default(false) %}
if ! backup_to_repo "S3" "RESTIC_REPO_S3"; then
    echo "✗ S3 backup failed!"
    OVERALL_SUCCESS=false
fi
{% endif %}

{% if backups.destinations.b2.enabled | default(false) %}
if ! backup_to_repo "B2" "RESTIC_REPO_B2"; then
    echo "✗ B2 backup failed!"
    OVERALL_SUCCESS=false
fi
{% endif %}

{% if backups.destinations.sftp.enabled | default(false) %}
if ! backup_to_repo "SFTP" "RESTIC_REPO_SFTP"; then
    echo "✗ SFTP backup failed!"
    OVERALL_SUCCESS=false
fi
{% endif %}

# Summary
echo ""
echo "=========================================="
if [ "$OVERALL_SUCCESS" = true ]; then
    echo "✓ All backups completed successfully!"
    notify_uptime_kuma "up" "backup-success"
    exit 0
else
    echo "✗ Some backups failed! Check log for details."
    notify_uptime_kuma "down" "backup-failed"
    exit 1
fi
