---
# =============================================================================
# target.yml — Full target node deployment
# =============================================================================
# Deploys all foundation + agent roles on target nodes.
#
# Usage:
#   ansible-playbook playbooks/target.yml
#   ansible-playbook playbooks/target.yml --limit server1

- name: Target nodes — Foundation
  hosts: targets
  gather_facts: true
  tags: [foundation]
  pre_tasks:
    - name: Auto-detect virtualization skip flags
      ansible.builtin.set_fact:
        lvm_skip: "{{ lvm_skip | default(ansible_virtualization_type == 'lxc') }}"
        swap_skip: "{{ swap_skip | default(ansible_virtualization_type == 'lxc') }}"
        qemu_agent_skip: "{{ qemu_agent_skip | default(ansible_virtualization_type not in ['kvm', 'qemu']) }}"
  roles:
    - { role: common, tags: [common] }
    - { role: lvm_config, tags: [lvm_config] }
    - { role: swap, tags: [swap] }
    - { role: qemu_agent, tags: [qemu_agent] }
    - { role: security, tags: [security] }
    - { role: docker, tags: [docker] }
    - { role: watchtower, tags: [watchtower] }
    - { role: restic, tags: [restic] }

- name: Target nodes — Agents
  hosts: targets
  tags: [agents]
  roles:
    - { role: netdata, tags: [netdata], vars: { netdata_mode: "child" } }
    - { role: promtail, tags: [promtail] }
    - { role: docker_socket_proxy, tags: [docker_socket_proxy] }
    - { role: dockge, tags: [dockge] }
