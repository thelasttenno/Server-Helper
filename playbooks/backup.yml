# Server Helper v1.0.0 - Backup Playbook
# Run manual backups: ansible-playbook playbooks/backup.yml

---
- name: Run Manual Backup
  hosts: all
  become: yes
  gather_facts: yes

  vars_files:
    - ../group_vars/all.yml
    - ../group_vars/vault.yml

  pre_tasks:
    - name: Display backup banner
      ansible.builtin.debug:
        msg: |
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘    Server Helper - Manual Backup       â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    - name: Check if backups are enabled
      ansible.builtin.fail:
        msg: "Backups are not enabled in configuration"
      when: not (backups.enabled | default(false))

  tasks:
    - name: Run Restic backup script
      ansible.builtin.command: "{{ base_install_dir }}/scripts/backup.sh"
      register: backup_result
      tags: [backup]
    
    - name: Display backup output
      ansible.builtin.debug:
        msg: "{{ backup_result.stdout_lines }}"
      when: backup_result.stdout_lines is defined
  
  post_tasks:
    - name: Send backup heartbeat to Uptime Kuma
      ansible.builtin.uri:
        url: "{{ monitoring.uptime_kuma.push_monitors.backup }}?status=up&msg=manual-backup-complete"
        method: GET
        status_code: [200, 201]
      when: monitoring.uptime_kuma.push_monitors.backup | default('') | length > 0
      ignore_errors: yes
    
    - name: Display completion message
      ansible.builtin.debug:
        msg: |
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘    Backup Complete!                    â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          ğŸ“Š Check backup status:
          - Log file: /var/log/restic-backup.log
          - List snapshots: restic -r /path/to/repo snapshots
          
          ğŸ’¡ Restore instructions:
          1. List snapshots: restic -r <repo> snapshots
          2. Restore: restic -r <repo> restore <snapshot-id> --target /tmp/restore
