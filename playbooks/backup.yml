---
# =============================================================================
# backup.yml â€” Trigger manual Restic backups
# =============================================================================
# Triggers an immediate Restic backup on all hosts.
#
# Usage:
#   ansible-playbook playbooks/backup.yml
#   ansible-playbook playbooks/backup.yml --limit server1

- name: Trigger manual backups
  hosts: all
  gather_facts: false
  tags: [backup]
  tasks:
    - name: Trigger Restic backup
      ansible.builtin.systemd:
        name: restic-backup.service
        state: started
      register: backup_trigger

    - name: Wait for backup to complete
      ansible.builtin.command: systemctl is-active restic-backup.service
      register: backup_status
      until: backup_status.stdout != "activating"
      retries: 60
      delay: 30
      changed_when: false
      failed_when: false

    - name: Check backup result
      ansible.builtin.command: journalctl -u restic-backup.service --no-pager -n 5
      register: backup_log
      changed_when: false

    - name: Display backup result
      ansible.builtin.debug:
        msg: "{{ inventory_hostname }}: {{ backup_log.stdout_lines[-1] | default('Check logs') }}"
