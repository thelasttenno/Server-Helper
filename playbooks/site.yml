---
# =============================================================================
# Server Helper v0.4.0 — Main Playbookml (Main Entry Point)
# =============================================================================
# Full 3-tier deployment:
#   1. Pre-flight: Detect virtualization, set skip flags
#   2. Tier 1: Foundation roles on ALL nodes
#   3. Tier 2: Agent roles on TARGET nodes
#   4. Tier 3: Control stacks on CONTROL node
#   5. Post-deploy: Distribute Step-CA root cert
#   6. Validation: Health checks and summary
#
# Usage:
#   ansible-playbook playbooks/site.yml
#   ansible-playbook playbooks/site.yml --limit server1
#   ansible-playbook playbooks/site.yml --check --diff

# =============================================================================
# PRE-FLIGHT: Detect virtualization and set skip flags (improvement #4)
# =============================================================================
- name: Pre-flight checks
  hosts: all
  gather_facts: true
  tags: [always]
  tasks:
    - name: Display target information
      ansible.builtin.debug:
        msg: >-
          Host: {{ inventory_hostname }} |
          OS: {{ ansible_distribution }} {{ ansible_distribution_version }} |
          Virtualization: {{ ansible_virtualization_type | default('none') }} |
          Role: {{ ansible_virtualization_role | default('none') }}

    - name: Auto-detect LXC containers and set skip flags
      ansible.builtin.set_fact:
        lvm_skip: "{{ lvm_skip | default(ansible_virtualization_type == 'lxc') }}"
        swap_skip: "{{ swap_skip | default(ansible_virtualization_type == 'lxc') }}"
        qemu_agent_skip: "{{ qemu_agent_skip | default(ansible_virtualization_type not in ['kvm', 'qemu']) }}"

    - name: Display skip flags
      ansible.builtin.debug:
        msg: >-
          Skip flags — LVM: {{ lvm_skip }} | Swap: {{ swap_skip }} | QEMU: {{ qemu_agent_skip }}

# =============================================================================
# TIER 1: Foundation (ALL nodes)
# =============================================================================
- name: "Tier 1: Foundation"
  hosts: all
  tags: [tier1, foundation]
  roles:
    - role: common
      tags: [common]
    - role: lvm_config
      tags: [lvm_config]
    - role: swap
      tags: [swap]
    - role: qemu_agent
      tags: [qemu_agent]
    - role: security
      tags: [security]
    - role: docker
      tags: [docker]
    - role: watchtower
      tags: [watchtower]
    - role: restic
      tags: [restic]
    - role: notifications
      tags: [notifications]

# =============================================================================
# TIER 2: Target Agents
# =============================================================================
- name: "Tier 2: Target Agents"
  hosts: targets
  tags: [tier2, agents]
  roles:
    - role: netdata
      tags: [netdata]
      vars:
        netdata_mode: "child"
    - role: promtail
      tags: [promtail]
    - role: docker_socket_proxy
      tags: [docker_socket_proxy]
    - role: dockge
      tags: [dockge]

# =============================================================================
# TIER 3: Control Stacks
# =============================================================================
- name: "Tier 3: Control Stacks"
  hosts: control
  tags: [tier3, control]
  roles:
    - role: traefik
      tags: [traefik]
    - role: authentik
      tags: [authentik]
    - role: step_ca
      tags: [step_ca]
    - role: pihole
      tags: [pihole]
    - role: loki
      tags: [loki]
    - role: netdata
      tags: [netdata]
      vars:
        netdata_mode: "parent"
    - role: grafana
      tags: [grafana]
    - role: uptime_kuma
      tags: [uptime_kuma]
    - role: dockge
      tags: [dockge]
    - role: homarr
      tags: [homarr]

# =============================================================================
# POST-DEPLOY: Distribute Step-CA root certificate
# =============================================================================
- name: Post-deployment — Distribute root CA
  hosts: targets
  tags: [post_deploy, step_ca]
  tasks:
    - name: Fetch Step-CA root certificate from control
      ansible.builtin.slurp:
        src: "{{ docker_stack_path }}/step-ca/certs/root_ca.crt"
      register: step_ca_root_cert
      delegate_to: "{{ groups['control'][0] }}"
      run_once: true
      ignore_errors: true

    - name: Install root CA on targets
      ansible.builtin.copy:
        content: "{{ step_ca_root_cert.content | b64decode }}"
        dest: /usr/local/share/ca-certificates/internal-ca.crt
        owner: root
        group: root
        mode: "0644"
      when: step_ca_root_cert is success
      notify: Update CA certificates

  handlers:
    - name: Update CA certificates
      ansible.builtin.command: update-ca-certificates
      changed_when: true

# =============================================================================
# VALIDATION: Health checks and deployment summary
# =============================================================================
- name: Validation — Health checks
  hosts: control
  tags: [validation]
  tasks:
    - name: Check control services health
      ansible.builtin.uri:
        url: "http://localhost:{{ item.port }}{{ item.path }}"
        method: GET
        status_code: [200, 301, 302]
        timeout: 10
      loop:
        - { name: "Traefik", port: "{{ control_traefik.dashboard_port }}", path: "/ping" }
        - { name: "Grafana", port: "{{ control_grafana.port }}", path: "/api/health" }
        - { name: "Netdata", port: "{{ control_netdata.port }}", path: "/api/v1/info" }
        - { name: "Loki", port: "{{ control_loki.port }}", path: "/ready" }
        - { name: "Uptime Kuma", port: "{{ control_uptime_kuma.port }}", path: "/" }
      register: health_results
      ignore_errors: true

    - name: Display deployment summary
      ansible.builtin.debug:
        msg: |
          ══════════════════════════════════════════════════
          Server Helper v0.4.0 — Deployment Complete
          ══════════════════════════════════════════════════

          Service URLs:
            Traefik:     https://traefik.{{ target_domain }}
            Grafana:     https://grafana.{{ target_domain }}
            Netdata:     https://netdata.{{ target_domain }}
            Uptime Kuma: https://status.{{ target_domain }}
            Pi-hole:     https://pihole.{{ target_domain }}
            Authentik:   https://auth.{{ target_domain }}
            Step-CA:     https://step-ca.{{ target_domain }}
            Dockge:      https://dockge.{{ target_domain }}
            Homarr:      https://dashboard.{{ target_domain }}
            Homarr:      https://dashboard.{{ target_domain }}

          ══════════════════════════════════════════════════
