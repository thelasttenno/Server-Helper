---
# =============================================================================
# update.yml â€” Rolling system updates
# =============================================================================
# Performs rolling apt upgrade and Watchtower one-shot on all nodes.
#
# Usage:
#   ansible-playbook playbooks/update.yml
#   ansible-playbook playbooks/update.yml --tags reboot

- name: Rolling system updates
  hosts: all
  serial: 1
  gather_facts: true
  tags: [update]
  tasks:
    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true

    - name: Perform safe apt upgrade
      ansible.builtin.apt:
        upgrade: safe
      register: apt_result

    - name: Display upgrade results
      ansible.builtin.debug:
        msg: "Packages upgraded: {{ apt_result.stdout_lines | default([]) | length }}"

    - name: Trigger Watchtower one-shot update
      community.docker.docker_container:
        name: watchtower
        command: "--run-once"
        restart: true
      ignore_errors: true

    - name: Check if reboot is required
      ansible.builtin.stat:
        path: /var/run/reboot-required
      register: reboot_check

    - name: Display reboot status
      ansible.builtin.debug:
        msg: "{{ 'REBOOT REQUIRED' if reboot_check.stat.exists else 'No reboot needed' }}"

- name: Reboot if required
  hosts: all
  serial: 1
  tags: [reboot, never]
  tasks:
    - name: Check if reboot is required
      ansible.builtin.stat:
        path: /var/run/reboot-required
      register: reboot_required

    - name: Reboot server
      ansible.builtin.reboot:
        reboot_timeout: 300
        msg: "Rebooting for system updates"
      when: reboot_required.stat.exists

    - name: Wait for server to come back
      ansible.builtin.wait_for_connection:
        delay: 30
        timeout: 300
      when: reboot_required.stat.exists
