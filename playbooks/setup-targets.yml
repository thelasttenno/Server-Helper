---
# Server Helper v1.0.0 - Target Node Setup Playbook
# ===================================================
# This playbook configures target servers with essential services.
# Run this on all target nodes that will be managed by your control node.
#
# Services installed on target nodes:
#   - Docker & Docker Compose
#   - Dockge: Container stack management (per-server)
#   - Netdata: System metrics collection (per-server)
#   - Restic: Encrypted backups (per-server)
#   - Security: fail2ban, UFW firewall, SSH hardening
#   - Lynis: Security auditing (per-server)
#
# NOT installed on target nodes:
#   - Uptime Kuma: Install on control node with setup-control.yml
#
# Usage:
#   ansible-playbook playbooks/setup-targets.yml
#   ansible-playbook playbooks/setup-targets.yml --limit server-01
#   ansible-playbook playbooks/setup-targets.yml --limit production
#
# Prerequisites:
#   - Targets bootstrapped (Python 3, SSH, sudo user)
#   - Inventory configured (inventory/hosts.yml)
#   - Variables configured (group_vars/all.yml)
#   - Vault configured (group_vars/vault.yml)
#

- name: Server Helper - Target Nodes Setup
  hosts: all
  gather_facts: true

  vars_files:
    - ../group_vars/all.yml
    - ../group_vars/vault.yml

  vars_prompt:
    - name: confirm_setup
      prompt: "This will configure {{ ansible_play_hosts | length }} target server(s). Continue? (yes/no)"
      private: false
      default: "no"

  pre_tasks:
    - name: Verify setup confirmation
      ansible.builtin.fail:
        msg: "Setup cancelled by user"
      when: confirm_setup | lower != 'yes'

    - name: Display banner
      ansible.builtin.debug:
        msg:
          - "╔════════════════════════════════════════╗"
          - "║  Server Helper v1.0.0 - Ansible       ║"
          - "║  Target Node Configuration             ║"
          - "╚════════════════════════════════════════╝"
      run_once: true

    - name: Display target servers
      ansible.builtin.debug:
        msg: |
          Configuring target servers:
          {% for host in ansible_play_hosts %}
            - {{ hostvars[host]['inventory_hostname'] }}: {{ hostvars[host]['ansible_host'] }}
          {% endfor %}
      run_once: true

    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600
      when: ansible_os_family == "Debian"

  roles:
    # ==============================================
    # Base System Setup & Docker Installation
    # ==============================================
    - role: system_setup
      tags: ['system', 'setup', 'docker', 'base']

    # ==============================================
    # Storage Configuration (Optional)
    # ==============================================
    - role: lvm_config
      tags: ['lvm', 'storage', 'partitioning']
      when: target_lvm_config.enabled | default(false)

    # ==============================================
    # User Management (Optional)
    # ==============================================
    - role: system_users
      tags: ['users', 'security', 'sudo']
      when: target_system_users.create_admin_user | default(false)

    # ==============================================
    # NAS Mounts (Optional)
    # ==============================================
    - role: nas_mounts
      tags: ['nas', 'storage']
      when: target_nas_mounts.enabled | default(false)

    # ==============================================
    # Security Hardening
    # ==============================================
    - role: security
      tags: ['security', 'hardening', 'firewall', 'ssh']
      when: target_security is defined

    # ==============================================
    # Container Management - Dockge
    # ==============================================
    - role: dockge
      tags: ['dockge', 'docker', 'containers']
      when: target_dockge.enabled | default(true)

    # ==============================================
    # Monitoring - Netdata Only
    # NOTE: Uptime Kuma is NOT installed on target nodes
    # Install it on the control node with setup-control.yml
    # ==============================================
    - role: netdata
      tags: ['monitoring', 'netdata', 'metrics']
      when: target_netdata.enabled | default(true)

    # ==============================================
    # Logging & Visualization - Loki + Promtail + Grafana
    # ==============================================
    - role: logging
      tags: ['logging', 'loki', 'promtail', 'grafana', 'visualization']
      when: target_logging.loki.enabled | default(true) or target_logging.grafana.enabled | default(true)

    # ==============================================
    # Backups - Restic
    # ==============================================
    - role: restic
      tags: ['backups', 'restic']
      when: target_restic.enabled | default(false)

    # ==============================================
    # Reverse Proxy (Optional)
    # ==============================================
    - role: proxy
      tags: ['proxy', 'traefik', 'nginx']
      when: target_reverse_proxy.enabled | default(false)

  post_tasks:
    - name: Display setup complete message
      ansible.builtin.debug:
        msg: |
          ═══════════════════════════════════════
                Target Node Setup Complete!
          ═══════════════════════════════════════

          Server: {{ inventory_hostname }}
          IP: {{ ansible_default_ipv4.address }}

          Services installed:
            ✓ Docker & Docker Compose
          {% if target_dockge.enabled | default(true) %}
            ✓ Dockge: http://{{ ansible_default_ipv4.address }}:{{ target_dockge.port }}
          {% endif %}
          {% if target_netdata.enabled | default(true) %}
            ✓ Netdata: http://{{ ansible_default_ipv4.address }}:{{ target_netdata.port }}
          {% endif %}
          {% if target_logging.grafana.enabled | default(true) %}
            ✓ Grafana: http://{{ ansible_default_ipv4.address }}:{{ target_logging.grafana.port }}
          {% endif %}
          {% if target_logging.loki.enabled | default(true) %}
            ✓ Loki: http://{{ ansible_default_ipv4.address }}:{{ target_logging.loki.port }}
          {% endif %}
          {% if target_restic.enabled | default(false) %}
            ✓ Restic Backups: Scheduled for {{ target_restic.schedule }}
          {% endif %}
          {% if target_security.fail2ban.enabled | default(true) %}
            ✓ fail2ban: Active
          {% endif %}
          {% if target_security.ufw.enabled | default(true) %}
            ✓ UFW Firewall: Active
          {% endif %}
          {% if target_security.lynis.enabled | default(true) %}
            ✓ Lynis Security Auditing: Scheduled
          {% endif %}

          Next steps:
            1. Access Dockge to manage container stacks
            2. Check Netdata for system metrics
          {% if target_restic.enabled | default(false) %}
            3. Verify backup repositories initialized
          {% endif %}
            4. Configure monitoring from control node (Uptime Kuma)

    - name: Save service URLs per node
      ansible.builtin.copy:
        content: |
          # Server Helper - Target Node Services
          # Server: {{ inventory_hostname }}
          # Generated: {{ ansible_date_time.iso8601 }}

          {% if target_dockge.enabled | default(true) %}
          Dockge: http://{{ ansible_default_ipv4.address }}:{{ target_dockge.port }}
          {% endif %}
          {% if target_netdata.enabled | default(true) %}
          Netdata: http://{{ ansible_default_ipv4.address }}:{{ target_netdata.port }}
          {% endif %}
          {% if target_logging.grafana.enabled | default(true) %}
          Grafana: http://{{ ansible_default_ipv4.address }}:{{ target_logging.grafana.port }}
          {% endif %}
          {% if target_logging.loki.enabled | default(true) %}
          Loki: http://{{ ansible_default_ipv4.address }}:{{ target_logging.loki.port }}
          {% endif %}
          {% if target_reverse_proxy.enabled | default(false) %}
          Traefik Dashboard: http://{{ ansible_default_ipv4.address }}:{{ target_reverse_proxy.traefik.dashboard_port }}
          {% endif %}

          Monitoring:
          - Centralized Uptime Kuma: Install on control node with playbooks/setup-control.yml
        dest: "{{ target_base_dir }}/service_urls.txt"
        mode: '0644'

    - name: Create summary report (run_once)
      ansible.builtin.debug:
        msg: |
          ═══════════════════════════════════════════════════════════
                All Target Nodes Configured Successfully!
          ═══════════════════════════════════════════════════════════

          Configured {{ ansible_play_hosts | length }} server(s):
          {% for host in ansible_play_hosts %}
            ✓ {{ hostvars[host]['inventory_hostname'] }} - {{ hostvars[host]['ansible_default_ipv4']['address'] }}
          {% endfor %}

          Recommended next steps:
            1. Install centralized monitoring on control node:
               ansible-playbook playbooks/setup-control.yml

            2. Access services on each server:
          {% for host in ansible_play_hosts %}
               {{ hostvars[host]['inventory_hostname'] }}:
                 - Dockge: http://{{ hostvars[host]['ansible_default_ipv4']['address'] }}:{{ target_dockge.port }}
                 - Netdata: http://{{ hostvars[host]['ansible_default_ipv4']['address'] }}:{{ target_netdata.port }}
          {% endfor %}

            3. Useful commands:
               ansible all -m shell -a 'docker ps'  # View containers
               ansible all -m ping                  # Test connectivity
               ansible-playbook playbooks/backup.yml  # Run backups
      run_once: true
