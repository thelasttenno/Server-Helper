---
# =============================================================================
# bootstrap.yml â€” Day-0 target node preparation
# =============================================================================
# Prepares new servers with Python, SSH keys, and base packages.
# Run this before site.yml on fresh servers.
#
# Usage:
#   ansible-playbook playbooks/bootstrap.yml
#   ansible-playbook playbooks/bootstrap.yml --limit new-server

- name: Bootstrap target nodes
  hosts: all
  gather_facts: false
  become: true
  tags: [bootstrap]

  pre_tasks:
    - name: Wait for SSH
      ansible.builtin.wait_for_connection:
        timeout: 60

    - name: Install Python (required for Ansible)
      ansible.builtin.raw: |
        test -e /usr/bin/python3 || (apt-get update && apt-get install -y python3 python3-apt)
      changed_when: false

    - name: Gather facts after Python install
      ansible.builtin.setup:

  tasks:
    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600

    - name: Install base packages
      ansible.builtin.apt:
        name:
          - python3
          - python3-apt
          - python3-pip
          - sudo
          - curl
          - wget
          - openssh-server
          - ca-certificates
        state: present

    - name: Ensure admin user exists
      ansible.builtin.user:
        name: "{{ ansible_user }}"
        groups: sudo
        append: true
        shell: /bin/bash

    - name: Set authorized SSH key
      ansible.posix.authorized_key:
        user: "{{ ansible_user }}"
        state: present
        key: "{{ vault_system_users.admin_ssh_key }}"
      when: vault_system_users.admin_ssh_key | default('') | length > 0

    - name: Ensure sudo without password for admin
      ansible.builtin.lineinfile:
        path: /etc/sudoers.d/90-admin-nopasswd
        line: "{{ ansible_user }} ALL=(ALL) NOPASSWD:ALL"
        create: true
        validate: "visudo -cf %s"
        owner: root
        group: root
        mode: "0440"

    - name: Display bootstrap complete message
      ansible.builtin.debug:
        msg: "Bootstrap complete for {{ inventory_hostname }}. Ready for site.yml deployment."
