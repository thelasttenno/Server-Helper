---
# Bootstrap playbook - Day 0 target preparation
# Prepares fresh servers with base configuration
#
# Usage:
#   ansible-playbook playbooks/bootstrap.yml
#   ansible-playbook playbooks/bootstrap.yml --limit "new-server"
#
# This playbook is idempotent and can be run multiple times safely.

- name: Server Helper - Bootstrap Target Nodes
  hosts: targets
  become: true
  gather_facts: true

  pre_tasks:
    - name: Display bootstrap information
      ansible.builtin.debug:
        msg: |
          ================================================
          Bootstrapping: {{ inventory_hostname }}
          ================================================
          IP: {{ ansible_host | default(ansible_default_ipv4.address) }}
          OS: {{ ansible_distribution }} {{ ansible_distribution_version }}
          Virtualization: {{ ansible_virtualization_type | default('unknown') }}
          ================================================

    - name: Detect if running in LXC container
      ansible.builtin.set_fact:
        is_lxc: "{{ ansible_virtualization_type == 'lxc' }}"

    - name: Set skip flags for LXC containers
      ansible.builtin.set_fact:
        lvm_skip: "{{ is_lxc or (lvm_skip | default(false)) }}"
        swap_skip: "{{ is_lxc or (swap_skip | default(false)) }}"
        qemu_agent_skip: "{{ is_lxc or (qemu_agent_skip | default(false)) }}"
      when: is_lxc | bool

    - name: Display LXC detection result
      ansible.builtin.debug:
        msg: "LXC container detected - skipping LVM, swap, and QEMU agent"
      when: is_lxc | bool

  roles:
    - role: common
      tags: [common, base]

    - role: lvm_config
      tags: [lvm, storage]
      when: not (lvm_skip | default(false) | bool)

    - role: swap
      tags: [swap, memory]
      when: not (swap_skip | default(false) | bool)

    - role: qemu_agent
      tags: [qemu, virtualization]
      when: not (qemu_agent_skip | default(false) | bool)

    - role: security
      tags: [security, hardening]

    - role: docker
      tags: [docker, containers]

  post_tasks:
    - name: Verify Docker installation
      ansible.builtin.command: docker --version
      register: docker_check
      changed_when: false

    - name: Display bootstrap completion
      ansible.builtin.debug:
        msg: |
          ================================================
          Bootstrap Complete: {{ inventory_hostname }}
          ================================================
          Docker: {{ docker_check.stdout }}
          LVM Extended: {{ 'Skipped' if (lvm_skip | default(false)) else 'Yes' }}
          Swap Created: {{ 'Skipped' if (swap_skip | default(false)) else 'Yes' }}
          QEMU Agent: {{ 'Skipped' if (qemu_agent_skip | default(false)) else 'Installed' }}
          Security Hardened: Yes
          ================================================

          Next steps:
          - Run 'ansible-playbook playbooks/target.yml' to deploy services
          - Or run 'ansible-playbook playbooks/site.yml' for full deployment

          ================================================
