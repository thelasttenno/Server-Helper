---
# =============================================================================
# control.yml — Full control node deployment
# =============================================================================
# Deploys all foundation + control stack roles on the control node.
#
# Usage:
#   ansible-playbook playbooks/control.yml

- name: Control node — Foundation
  hosts: control
  gather_facts: true
  tags: [foundation]
  pre_tasks:
    - name: Auto-detect virtualization skip flags
      ansible.builtin.set_fact:
        lvm_skip: "{{ lvm_skip | default(ansible_virtualization_type == 'lxc') }}"
        swap_skip: "{{ swap_skip | default(ansible_virtualization_type == 'lxc') }}"
        qemu_agent_skip: "{{ qemu_agent_skip | default(ansible_virtualization_type not in ['kvm', 'qemu']) }}"
  roles:
    - { role: common, tags: [common] }
    - { role: lvm_config, tags: [lvm_config] }
    - { role: swap, tags: [swap] }
    - { role: qemu_agent, tags: [qemu_agent] }
    - { role: security, tags: [security] }
    - { role: docker, tags: [docker] }
    - { role: watchtower, tags: [watchtower] }
    - { role: restic, tags: [restic] }

- name: Control node — Stacks
  hosts: control
  tags: [stacks]
  roles:
    - { role: traefik, tags: [traefik] }
    - { role: authentik, tags: [authentik] }
    - { role: step_ca, tags: [step_ca] }
    - { role: pihole, tags: [pihole] }
    - { role: loki, tags: [loki] }
    - { role: netdata, tags: [netdata], vars: { netdata_mode: "parent" } }
    - { role: grafana, tags: [grafana] }
    - { role: uptime_kuma, tags: [uptime_kuma] }
    - { role: dockge, tags: [dockge] }
