# Server Helper v1.0.0 - Security Audit Playbook
# Run security audit: ansible-playbook playbooks/security.yml

---
- name: Security Audit and Hardening
  hosts: all
  become: yes
  gather_facts: yes
  
  pre_tasks:
    - name: Display security banner
      debug:
        msg: |
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘    Server Helper - Security Audit      â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  tasks:
    # Run Lynis security audit
    - name: Run Lynis security scan
      include_role:
        name: lynis
        tasks_from: scan.yml
      when: security.lynis_enabled
      tags: [lynis, audit]
    
    # Check security configurations
    - name: Check SSH configuration
      block:
        - name: Check SSH password authentication
          shell: grep "^PasswordAuthentication" /etc/ssh/sshd_config || echo "not set"
          register: ssh_password_auth
          changed_when: false
        
        - name: Check SSH root login
          shell: grep "^PermitRootLogin" /etc/ssh/sshd_config || echo "not set"
          register: ssh_root_login
          changed_when: false
        
        - name: Display SSH security status
          debug:
            msg: |
              SSH Security:
              - Password Auth: {{ ssh_password_auth.stdout }}
              - Root Login: {{ ssh_root_login.stdout }}
      tags: [ssh, audit]
    
    # Check firewall status
    - name: Check UFW status
      shell: ufw status verbose
      register: ufw_status
      changed_when: false
      when: security.ufw_enabled
      tags: [firewall, audit]
    
    - name: Display firewall status
      debug:
        msg: "{{ ufw_status.stdout_lines }}"
      when: security.ufw_enabled
      tags: [firewall, audit]
    
    # Check fail2ban status
    - name: Check fail2ban status
      shell: fail2ban-client status
      register: fail2ban_status
      changed_when: false
      when: security.fail2ban_enabled
      tags: [fail2ban, audit]
    
    - name: Display fail2ban status
      debug:
        msg: "{{ fail2ban_status.stdout_lines }}"
      when: security.fail2ban_enabled
      tags: [fail2ban, audit]
    
    # Check for available updates
    - name: Check for security updates
      shell: apt list --upgradable 2>/dev/null | grep -i security || echo "No security updates"
      register: security_updates
      changed_when: false
      tags: [updates, audit]
    
    - name: Display security updates
      debug:
        msg: "{{ security_updates.stdout_lines }}"
      tags: [updates, audit]
  
  post_tasks:
    - name: Generate security report
      template:
        src: ../templates/security-report.j2
        dest: /var/log/security-audit-{{ ansible_date_time.date }}.txt
        mode: '0600'
      tags: [report]
    
    - name: Display audit summary
      debug:
        msg: |
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘    Security Audit Complete!            â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          ðŸ“Š Reports generated:
          - Lynis: /var/log/lynis/report.dat
          - Summary: /var/log/security-audit-{{ ansible_date_time.date }}.txt
          
          ðŸ”’ Security Status:
          {% if security.ufw_enabled %}
          âœ“ Firewall (UFW): Active
          {% else %}
          âš  Firewall (UFW): Disabled
          {% endif %}
          {% if security.fail2ban_enabled %}
          âœ“ Intrusion Prevention (fail2ban): Active
          {% else %}
          âš  Intrusion Prevention (fail2ban): Disabled
          {% endif %}
          {% if security.ssh_hardening %}
          âœ“ SSH Hardening: Enabled
          {% else %}
          âš  SSH Hardening: Disabled
          {% endif %}
          
          ðŸ’¡ Recommendations:
          - Review Lynis report for detailed findings
          - Apply security hardening if not done
          - Keep system updated
          - Review firewall rules regularly
    
    - name: Send security scan heartbeat to Uptime Kuma
      uri:
        url: "{{ security.lynis_uptime_kuma_push_url }}?status=up&msg=security-scan-complete"
        method: POST
        status_code: [200, 201]
      when: security.lynis_uptime_kuma_push_url | default('') | length > 0
      ignore_errors: yes
