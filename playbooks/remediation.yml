---
# Automated Remediation Playbook
# Triggered by monitoring alerts to automatically fix common issues
# Can be called by Uptime Kuma webhooks or Prometheus Alertmanager

- name: Automated System Remediation
  hosts: all
  become: true
  vars_files:
    - ../group_vars/all.yml
    - ../group_vars/vault.yml
  vars:
    remediation_action: "{{ action | default('health_check') }}"
    affected_service: "{{ service | default('') }}"
    disk_path: "{{ path | default('/') }}"
    alert_severity: "{{ severity | default('warning') }}"

  tasks:
    # =============================================================================
    # SERVICE AUTO-RESTART
    # =============================================================================

    - name: Detect failed Docker containers
      shell: docker ps -a --filter "status=exited" --filter "status=dead" --format "{{`{{.Names}}`}}"
      register: failed_containers
      changed_when: false
      when: remediation_action in ['service_restart', 'health_check']

    - name: Restart failed Docker containers
      community.docker.docker_container:
        name: "{{ item }}"
        state: started
        restart: true
      loop: "{{ failed_containers.stdout_lines }}"
      when:
        - remediation_action in ['service_restart', 'health_check']
        - failed_containers.stdout_lines | length > 0
      register: container_restart

    - name: Check systemd service status
      systemd:
        name: "{{ affected_service }}"
      register: service_status
      when:
        - remediation_action == 'service_restart'
        - affected_service != ''
      failed_when: false

    - name: Restart failed systemd service
      systemd:
        name: "{{ affected_service }}"
        state: restarted
        daemon_reload: true
      when:
        - remediation_action == 'service_restart'
        - affected_service != ''
        - service_status.status.ActiveState != 'active'

    # =============================================================================
    # DISK CLEANUP
    # =============================================================================

    - name: Check disk usage
      shell: df -h {{ disk_path }} | tail -1 | awk '{print $5}' | sed 's/%//'
      register: disk_usage_percent
      changed_when: false
      when: remediation_action in ['disk_cleanup', 'health_check']

    - name: Run disk cleanup if usage is high
      block:
        - name: Clean Docker system (dangling images, stopped containers)
          command: docker system prune -f
          register: docker_prune

        - name: Remove old Docker images (not used in 30 days)
          shell: |
            docker image prune -a --filter "until=720h" -f
          register: image_prune

        - name: Clean apt cache
          apt:
            autoclean: true
            autoremove: true
          when: ansible_os_family == "Debian"

        - name: Clean old logs (older than 30 days)
          shell: find /var/log -type f -name "*.log" -mtime +30 -delete
          register: log_cleanup

        - name: Clean systemd journal (keep last 7 days)
          command: journalctl --vacuum-time=7d
          register: journal_cleanup

        - name: Clean tmp files (older than 10 days)
          shell: find /tmp -type f -atime +10 -delete
          register: tmp_cleanup

        - name: Report cleanup results
          debug:
            msg:
              - "Disk cleanup completed on {{ disk_path }}"
              - "Previous usage: {{ disk_usage_percent.stdout }}%"
              - "Docker prune: {{ docker_prune.stdout }}"
              - "Old images removed: {{ image_prune.stdout }}"

      when:
        - remediation_action in ['disk_cleanup', 'health_check']
        - disk_usage_percent.stdout | int > 80

    # =============================================================================
    # CERTIFICATE RENEWAL
    # =============================================================================

    - name: Check for expiring certificates
      shell: |
        find /etc -name "*.crt" -o -name "*.pem" | while read cert; do
          if openssl x509 -checkend 864000 -noout -in "$cert" 2>/dev/null; then
            :
          else
            echo "$cert"
          fi
        done
      register: expiring_certs
      changed_when: false
      when: remediation_action in ['cert_renewal', 'health_check']

    - name: Renew Let's Encrypt certificates (if using certbot)
      command: certbot renew --quiet
      when:
        - remediation_action == 'cert_renewal'
        - expiring_certs.stdout_lines | length > 0
      register: certbot_renewal
      failed_when: false

    - name: Reload services after certificate renewal
      systemd:
        name: "{{ item }}"
        state: reloaded
      loop:
        - traefik
      when:
        - remediation_action == 'cert_renewal'
        - certbot_renewal.changed
      failed_when: false

    # =============================================================================
    # HEALTH CHECKS & NOTIFICATIONS
    # =============================================================================

    - name: Perform comprehensive health check
      block:
        - name: Check system load
          command: uptime
          register: system_load
          changed_when: false

        - name: Check memory usage
          shell: free | grep Mem | awk '{printf "%.0f", $3/$2 * 100.0}'
          register: memory_usage
          changed_when: false

        - name: Check disk I/O
          command: iostat -x 1 2
          register: disk_io
          changed_when: false
          failed_when: false

        - name: Check for zombie processes
          shell: ps aux | awk '$8=="Z" {print $2}'
          register: zombie_processes
          changed_when: false

        - name: Report health status
          debug:
            msg:
              - "=== System Health Report ==="
              - "Load: {{ system_load.stdout }}"
              - "Memory Usage: {{ memory_usage.stdout }}%"
              - "Disk Usage ({{ disk_path }}): {{ disk_usage_percent.stdout }}%"
              - "Failed Containers: {{ failed_containers.stdout_lines | length }}"
              - "Zombie Processes: {{ zombie_processes.stdout_lines | length }}"

      when: remediation_action == 'health_check'

    - name: Send notification to Uptime Kuma (if configured)
      uri:
        url: "{{ uptime_kuma_push_url }}"
        method: GET
        status_code: 200
      when:
        - uptime_kuma_push_url is defined
        - uptime_kuma_push_url | length > 0
      failed_when: false